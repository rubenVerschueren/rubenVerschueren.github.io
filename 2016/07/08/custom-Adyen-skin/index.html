<!-- build time:Thu Sep 08 2016 15:25:33 GMT+0200 (Romance Daylight Time) --><!DOCTYPE HTML><html><head><meta charset="utf-8"><title>custom Adyen skin | Sitecorn</title><meta name="author" content="Ruben Verschueren"><meta name="description" content="web development tips &amp; tricks"><meta name="og:description" content="web development tips &amp; tricks"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:title" content="custom Adyen skin"><meta property="og:site_name" content="Sitecorn"><meta property="og:url" content="http://www.sitecorn.be/2016/07/08/custom-adyen-skin/"><meta property="og:image" content="http://www.sitecorn.be/images/sitecorn_large.png"><meta property="og:image:width" content="100"><meta property="og:image:height" content="121"><link rel="icon" type="image/png" href="http://www.sitecorn.be/images/fav.ico"><link href="http://www.sitecorn.be/images/sitecorn_large.png" rel="icon"><link rel="alternate" href="/atom.xml" title="Sitecorn" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/custom.css" media="screen" type="text/css"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-76954315-1","auto"),ga("send","pageview")</script></head></html><body><header id="header" class="inner"><div class="alignleft"><h1><a href="/">Sitecorn</a></h1><h2><a href="/">offering a few kernels of knowledge</a></h2></div><nav id="main-nav" class="alignright"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archives</a></li><li><a href="/about">About</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div id="content" class="inner"><div id="main-col" class="alignleft"><div id="wrapper"><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2016-07-08T14:30:35.974Z"><a href="/2016/07/08/custom-adyen-skin/">2016-07-08</a></time><h1 class="title">custom Adyen skin</h1></header><div class="entry"><p>When creating my first skin for Adyen I ran into the problem of translations. Adyen has got it’s language files which you can modify and update as much as you want. But here’s the kicker, once uploaded you cannot reach those files from your skin. This means that if you created a nice header with some text that needs translating, you’ll have to do it yourself.</p><p>So that’s what I did. I added some custom JSON files containing the required translations. They are stored as text files with the locale in the file name. I kept the name resources for convenience. example: resources_it_IT.txt Note that the hyphen is replaced with an underscore.</p><h3 id="shortcuts">Shortcuts</h3><p>Because I had trouble uploading these files in separate folders, I keep them in my javascript folder for now. I took another shortcut in the JSON (again as a proof of concept). The JSON structure is super simple and contains key/value pairs. The keys are actually the CSS selectors I will use to find the location of the text that needs to be translated This results in a somewhat dirty file, but keeps everything nice and simple.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="string">".contact"</span>: <span class="string">"Questions? Call us .... "</span>,</span><br><span class="line">   <span class="string">"h2"</span> : <span class="string">"CHECKOUT"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="script-with-jquery">Script with jQuery</h3><p>The javascript itself is also quite simple. I get the shopperLocale from the form that gets rendered inside the skin and default it to en-GB. Next I set the link on the logo on my skin to homepage in the correct language. Before getting the file, you need to construct a url which points to the correct directory. This has the following format: <strong>/sf/[SKINCODE]/js/[RESOURCE_FILE_NAME]</strong></p><p>Finally I get the file with the needed translations via an AJAX call, loop through the data and use the key/value pairs to set my translation on the page. All of which gets executed when the page has finished loading. Since I already had jquery loaded for other parts, I used it for this code as well.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// determine correct locale</span></span><br><span class="line"><span class="keyword">var</span> locale = $(<span class="string">'[name="shopperLocale"]'</span>).val();</span><br><span class="line"><span class="keyword">if</span> (locale == <span class="literal">null</span> || locale === <span class="string">""</span>) &#123;</span><br><span class="line">   locale = <span class="string">"en_GB"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set logo url to correct language, example: http://www.YOURDOMAIN.com/en-gb/</span></span><br><span class="line">$(<span class="string">".logo"</span>).attr(<span class="string">"href"</span>, <span class="string">"http://www.YOURDOMAIN.com/"</span> + locale.replace(<span class="string">"_"</span>, <span class="string">"-"</span>) + <span class="string">"/"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// construct resource url</span></span><br><span class="line"><span class="keyword">var</span> resourceUrl = <span class="string">"/sf/kTcgNKNd/js/resources_"</span> + locale + <span class="string">".txt"</span>;</span><br><span class="line"></span><br><span class="line">$.ajax(&#123;</span><br><span class="line">   url: resourceUrl,</span><br><span class="line">   contentType: <span class="string">"application/json; charset=utf-8"</span>,</span><br><span class="line">   dataType: <span class="string">"json"</span>,</span><br><span class="line">   success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">         <span class="comment">// loop through data and set translation text</span></span><br><span class="line">         $.each(data, <span class="function"><span class="keyword">function</span> (<span class="params">key, val</span>) </span>&#123;</span><br><span class="line">           $(key).html(val);</span><br><span class="line">         &#125;);   </span><br><span class="line">   &#125;,</span><br><span class="line">   error: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, ajaxOptions, thrownError</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(xhr.status);</span><br><span class="line">      <span class="built_in">console</span>.log(thrownError);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>As a final note to this, make sure all links to files in your skin have the same structure as the resource url. I haven’t had much luck with relative url’s using ../ in them. For instance here’s what the part of my skin footer that loads jquery and my script.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/sf/kTcgNKNd/js/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/sf/kTcgNKNd/js/checkout.js&gt;&lt;/script&gt;</span></span></span><br></pre></td></tr></table></figure><h3 id="display-custom-data">Display custom data</h3><p>Besides the need to display a large amount of data on the HPP (Hosted Payment Page), the customer wanted to display an overview of the order. The problem is that all data you submit to the HPP should be a encoded in the Merchant Signature and the more fields you add the more complicated everything gets. The solution is to make a dictionary of strings and serialize the object as json. This way you can pass it all as the orderdata field.</p><p>another way to do it is to build the html using some sort of string builder and pass that, perhaps url encode it before serializing just to be sure.</p><p>To decode it on the Adyen skin I used the following script. Since I used a dictionary of type <strong>dictionary<string ,="" string=""></string></strong>, I get name / value pairs after de-serialization so I added span tags to the skin which used the same names for their ID attribute.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> orderDataString = <span class="built_in">decodeURIComponent</span>($(<span class="string">"[name='orderData']"</span>).val());</span><br><span class="line"><span class="keyword">var</span> orderJson = $.parseJSON(orderDataString);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cost = $(<span class="string">"[name='paymentAmount']"</span>).val();</span><br><span class="line"><span class="keyword">if</span> (cost !== <span class="string">""</span> &amp;amp;&amp;amp; cost !== <span class="number">0</span>) &#123;</span><br><span class="line">	cost = cost / <span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line">$(<span class="string">"#totalCost"</span>).html(cost + <span class="string">" "</span> + $(<span class="string">"[name='currencyCode']"</span>).val());</span><br><span class="line"></span><br><span class="line">$.each(orderJson, <span class="function"><span class="keyword">function</span> (<span class="params">index, obj</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ($(<span class="string">"#"</span> + obj.Name) != <span class="literal">undefined</span> &amp;&amp; obj.Value != <span class="literal">undefined</span> </span><br><span class="line">		&amp;&amp; obj.Value !== <span class="string">""</span>) &#123;</span><br><span class="line">		<span class="keyword">var</span> val = obj.Value.split(<span class="string">"+"</span>).join(<span class="string">" "</span>);</span><br><span class="line">		<span class="keyword">if</span> (obj.Name === <span class="string">"billingPhone"</span>) &#123;</span><br><span class="line">			val = <span class="string">"+"</span> + val.substring(<span class="number">1</span>, val.length - <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (obj.Name === <span class="string">"backLink"</span>) &#123;</span><br><span class="line">			$(<span class="string">"#"</span> + obj.Name).attr(<span class="string">"href"</span>, val);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$(<span class="string">"#"</span> + obj.Name).html(val);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>In our case we were integrating with Sitecore and uCommerce. When submitting our first tests to the HPP’s we quickly realized it was a bust. As it turned out uCommerce was still using the SHA1 hashing to calculate the HMAC for the merchant signature. We requested the code they used and adapted it to use the SHA256 hashing. We gave our code back, so in case you need it before the next release, just ask your uCommerce buddy and he can hook you up.</p><p>In case you have some other .NET implementation, I made a pull request to the Adyen github, which was since added to their examples. Here you can find the new <a href="https://github.com/Adyen/asp.net/tree/master/AdyenExamples/1.HPP" target="_blank" rel="external">HPP example</a>.</p><h3 id="d-security">3D security</h3><p>If you want to add extra security, Adyen can activate the 3D secure option. For the shopper this means another form to fill out after the completion of the HPP. This extra page is provided by the card issues (aka the bank) so you don’t have any control over it. This includes the layout if you were wondering.</p><p>Our customer wanted to be extra safe, so we had Adyen enabe the 3D secure option. And that’s when it all blew up in my face. When you clicked on the pay button on the HPP page it started flashing. I soon realized this was the javascript that tried to add in the translations. It didn’t have the correct data however since it was the HPP and not our generated payment page that was being submitted.</p><p>To make matters worse there wasn’t any obvious indication why this was happening as everything worked fine without the 3D secure. After inspecting the skin closely I noticed a few issues. The first being we had some elements with the ID’s that Adyen’s was using for their elements on the HPP.</p><p>The biggest issue was that we added a form element in our skin which had the “pageform” as ID. So you can probably guess what happened. Adyen inserts a form element of it’s own with the same id. In fact the form they add, was inserted inside our form element. They’re using javascript to submit the form with id “pageform” and so it all came tumbling down.</p><p>In hindsight we didn’t need the form, so we could easily solve the problem by removing the form from our skin and using different id’s.</p><p>Another issue that can occur is that the payment is authorised but the issuer has some sort of issue. this results in a correct payment, without 3D secure. In that case it’s up to your customer to decide what to do. Adyen can set up rules to support two scenario’s.</p><p>Either the payment is accepted and the shopper is redirected to your confirmation/success page or the fraud score can be raised for those cases and the shopper is redirected to your cancel page.</p></div><footer><div class="tags"><a href="/tags/adyen-skin/">adyen skin</a>, <a href="/tags/hpp/">hpp</a></div><div class="addthis addthis_toolbox addthis_default_style"><a class="addthis_button_facebook_like" fb:like:layout="button_count"></a> <a class="addthis_button_tweet"></a> <a class="addthis_button_google_plusone" g:plusone:size="medium"></a> <a class="addthis_counter addthis_pill_style"></a></div><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js"></script><div class="clearfix"></div></footer></div></article><section id="comment"><h1 class="title">Comments</h1><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></div></div><aside id="sidebar" class="alignright"><a href="https://twitter.com/RubenVerschuern" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @RubenVerschuern</a><script>!function(t,e,r){var n,s=t.getElementsByTagName(e)[0],i=/^http:/.test(t.location)?"http":"https";t.getElementById(r)||(n=t.createElement(e),n.id=r,n.src=i+"://platform.twitter.com/widgets.js",s.parentNode.insertBefore(n,s))}(document,"script","twitter-wjs")</script><div class="widget tag"><h3 class="title">Tags</h3><ul class="entry"><li><a href="/tags/adyen-skin/">adyen skin</a><small>1</small></li><li><a href="/tags/autocomplete/">autocomplete</a><small>1</small></li><li><a href="/tags/blog/">blog</a><small>1</small></li><li><a href="/tags/browser-extensions/">browser extensions</a><small>1</small></li><li><a href="/tags/cheat-sheet/">cheat sheet</a><small>1</small></li><li><a href="/tags/extension-methods/">extension methods</a><small>1</small></li><li><a href="/tags/filter/">filter</a><small>1</small></li><li><a href="/tags/google-maps/">google maps</a><small>1</small></li><li><a href="/tags/hpp/">hpp</a><small>1</small></li><li><a href="/tags/itemlink/">itemlink</a><small>1</small></li><li><a href="/tags/javascript/">javascript</a><small>2</small></li><li><a href="/tags/markdown/">markdown</a><small>1</small></li><li><a href="/tags/mediarequest/">mediarequest</a><small>1</small></li><li><a href="/tags/multiple-renderings/">multiple renderings</a><small>1</small></li><li><a href="/tags/mvc/">mvc</a><small>1</small></li><li><a href="/tags/pdf/">pdf</a><small>1</small></li><li><a href="/tags/plugins/">plugins</a><small>1</small></li><li><a href="/tags/resharper/">resharper</a><small>1</small></li><li><a href="/tags/shortcut/">shortcut</a><small>1</small></li><li><a href="/tags/sitecore-8/">sitecore 8</a><small>4</small></li><li><a href="/tags/sql/">sql</a><small>3</small></li><li><a href="/tags/tools/">tools</a><small>1</small></li><li><a href="/tags/ucommerce/">ucommerce</a><small>3</small></li><li><a href="/tags/unit-testing/">unit testing</a><small>1</small></li><li><a href="/tags/visual-studio/">visual studio</a><small>1</small></li></ul></div></aside><div class="clearfix"></div></div><footer id="footer" class="inner"><div class="alignleft">&copy; 2016 Ruben Verschueren</div><div class="clearfix"></div></footer><script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="/js/jquery.imagesloaded.min.js"></script><script src="/js/gallery.js"></script><script type="text/javascript">var disqus_shortname="sitecorn";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript">!function(n){n(".fancybox").fancybox()}(jQuery)</script></body><!-- rebuild by neat -->