<!-- build time:Thu Sep 08 2016 15:50:36 GMT+0200 (Romance Daylight Time) --><!DOCTYPE HTML><html><head><meta charset="utf-8"><title>Archives: 2016/5 | Sitecorn</title><meta name="author" content="Ruben Verschueren"><meta name="description" content="web development tips &amp; tricks"><meta name="og:description" content="web development tips &amp; tricks"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:site_name" content="Sitecorn"><meta property="og:url" content="http://www.sitecorn.be/archives/2016/05/index.html"><meta property="og:image" content="http://www.sitecorn.be/images/sitecorn_large.png"><meta property="og:image:width" content="100"><meta property="og:image:height" content="121"><link rel="icon" type="image/png" href="http://www.sitecorn.be/images/fav.ico"><link href="http://www.sitecorn.be/images/sitecorn_large.png" rel="icon"><link rel="alternate" href="/atom.xml" title="Sitecorn" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/custom.css" media="screen" type="text/css"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-76954315-1","auto"),ga("send","pageview")</script></head></html><body><header id="header" class="inner"><div class="alignleft"><h1><a href="/">Sitecorn</a></h1><h2><a href="/">offering a few kernels of knowledge</a></h2></div><nav id="main-nav" class="alignright"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archives</a></li><li><a href="/about">About</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div id="content" class="inner"><div id="main-col" class="alignleft"><div id="wrapper"><h2 class="archive-title">2016/5</h2><div class="archive"><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2016-05-18T14:44:00.443Z"><a href="/2016/05/18/sql-cheatsheet/">2016-05-18</a></time><h1 class="title"><a href="/2016/05/18/sql-cheatsheet/">SQL cheatsheet: snippets and reference material</a></h1></header><div class="entry"><p>Here are a few of the SQL statements I keep googling for. I thought it would be helpful to keep the in one place, so I'll have a cheatsheet next time.</p><p><strong>Get a list of all tables in the database</strong></p><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">sys</span>.<span class="keyword">Tables</span></span><br><span class="line"><span class="comment">--OR</span></span><br><span class="line">EXEC sp_tables <span class="string">'%'</span>, <span class="string">'%'</span>, <span class="string">'master'</span>, <span class="string">"'TABLE'"</span></span><br></pre></td></tr></table></figure><p></p><p><strong>Get a list of all tables, views and system tables in the database</strong></p><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXEC sp_tables '%'</span><br></pre></td></tr></table></figure><p></p><p><strong>Get a list of tables that the view depends on</strong></p><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> view_name, Table_Name</span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.VIEW_TABLE_USAGE</span><br><span class="line"><span class="keyword">WHERE</span> View_Name = <span class="string">'&amp;lt;giveViewName&amp;gt;'</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> view_name, table_name</span><br></pre></td></tr></table></figure><p></p><p><strong>Get a list of all views that depend on a given table</strong></p><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> view_name, Table_Name</span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.VIEW_TABLE_USAGE</span><br><span class="line"><span class="keyword">WHERE</span> Table_Name= <span class="string">'Address'</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> view_name, table_name</span><br></pre></td></tr></table></figure><p></p><p><strong>Get al list of all functions</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ROUTINE_NAME</span><br><span class="line"><span class="keyword">FROM</span> INFORMATION_SCHEMA.ROUTINES</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">upper</span>(ROUTINE_TYPE) = <span class="string">'FUNCTION'</span></span><br></pre></td></tr></table></figure><p></p><p><strong>Get information about all fields in a certain table</strong></p><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> column_name, data_type,  is_nullable, character_maximum_length</span><br><span class="line"><span class="keyword">FROM</span> information_schema.<span class="keyword">columns</span></span><br><span class="line"><span class="keyword">WHERE</span> table_name=<span class="string">'contents'</span>;</span><br></pre></td></tr></table></figure><p></p><p><strong>Get a list of tables with their create and modified dates</strong></p><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span>, object_id, create_date, modify_date</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">sys</span>.<span class="keyword">tables</span>;</span><br></pre></td></tr></table></figure><p></p><p><strong>Get a list of constraints and the fields they apply to for a given table.</strong></p><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> a.table_name,  a.constraint_name, b.column_name,  a.constraint_type</span><br><span class="line"><span class="keyword">FROM</span> information_schema.table_constraints a, information_schema.key_column_usage b</span><br><span class="line"><span class="keyword">WHERE</span> a.table_name = <span class="string">'contents'</span></span><br><span class="line"><span class="keyword">AND</span>  a.table_name = b.table_name</span><br><span class="line"><span class="keyword">AND</span>  a.table_schema = b.table_schema</span><br><span class="line"><span class="keyword">AND</span>  a.constraint_name = b.constraint_name;</span><br></pre></td></tr></table></figure><p></p><p><strong>Example of how to generate a script for all tables</strong></p><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">'SELECT count(1) FROM &lt;a class="incipient" title="[click to create page]"'</span> + </span><br><span class="line"> <span class="string">' href="https://somelink/%27%20+%20table_name%20+%20%27"&gt;'</span> + table_name + <span class="string">'&lt;/a&gt;;'</span></span><br><span class="line"><span class="keyword">FROM</span> information_schema.<span class="keyword">tables</span>;</span><br></pre></td></tr></table></figure><p></p><p><strong>Get the definition (code) of a user defined stored procedure</strong></p><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> routine_definition <span class="keyword">FROM</span> INFORMATION_SCHEMA.ROUTINES</span><br><span class="line"><span class="keyword">WHERE</span> specific_name = ‘USP_NAME<span class="string">'</span></span><br></pre></td></tr></table></figure><p></p><p><strong>Retrieve the collation of a column</strong></p><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"><span class="keyword">col</span>.<span class="keyword">name</span>, <span class="keyword">col</span>.collation_name</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">sys</span>.<span class="keyword">columns</span> <span class="keyword">col</span></span><br><span class="line"><span class="keyword">WHERE</span> object_id = OBJECT_ID(<span class="string">'TableName'</span>)</span><br></pre></td></tr></table></figure><p></p><p><strong>Solve collation issues in a join, union, ...</strong></p><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tablename <span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> <span class="keyword">id</span></span><br><span class="line"><span class="keyword">COLLATE</span> Latin1_General_CI_AS <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br></pre></td></tr></table></figure><p></p><p><strong>Retrieve FK en PK information</strong></p><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sp_help ‘TABLENAME’</span><br></pre></td></tr></table></figure><p></p><p><strong>​Check whick document types can be searched with a full text search.</strong></p><p>uncomment the &quot;WHERE&quot; part to check for a specific document type (in this case pdf) ​</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> document_type, <span class="keyword">path</span> </span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">sys</span>.fulltext_document_types  </span><br><span class="line"><span class="comment">---WHERE document_type = '.pdf'</span></span><br></pre></td></tr></table></figure><p></p><p><strong>Another way of finding references between tables</strong></p><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> s1.<span class="keyword">name</span> <span class="keyword">as</span> FROM_schema</span><br><span class="line">, o1.<span class="keyword">Name</span> <span class="keyword">as</span> FROM_table</span><br><span class="line">, s2.<span class="keyword">name</span> <span class="keyword">as</span> to_schema</span><br><span class="line">, o2.<span class="keyword">Name</span> <span class="keyword">as</span> to_table</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">sys</span>.foreign_keys fk</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> <span class="keyword">sys</span>.objects o1</span><br><span class="line"><span class="keyword">ON</span> fk.parent_object_id = o1.object_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> <span class="keyword">sys</span>.schemas s1</span><br><span class="line"><span class="keyword">ON</span> o1.schema_id = s1.schema_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> <span class="keyword">sys</span>.objects o2</span><br><span class="line"><span class="keyword">ON</span> fk.referenced_object_id = o2.object_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> <span class="keyword">sys</span>.schemas s2</span><br><span class="line"><span class="keyword">ON</span> o2.schema_id = s2.schema_id</span><br><span class="line"><span class="comment">--For the purposes of finding dependency hierarchy</span></span><br><span class="line"><span class="comment">-- we're not worried about self-referencing tables</span></span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span>(s1.<span class="keyword">name</span> = s2.<span class="keyword">name</span> <span class="keyword">AND</span> o1.<span class="keyword">name</span> = o2.<span class="keyword">name</span>)</span><br></pre></td></tr></table></figure><p></p><h3>A word on collation</h3><h4>What is collation?</h4><p>Collation refers to a set of rules that determine how data is sorted and compared. Character data is sorted using rules that define the correct character sequence, with options for specifying case-sensitivity, accent marks, kana character types and character width.</p><h4>Case sensitivity</h4><p>If A and a, B and b, etc. are treated in the same way then it is case-insensitive. A computer treats A and a differently because it uses ASCII code to differentiate the input. The ASCII value of A is 65, while a is 97. The ASCII value of B is 66 and b is 98.</p><h4>Accent sensitivity</h4><p>If a and á, o and ó are treated in the same way, then it is accent-insensitive. A computer treats a and á differently because it uses ASCII code for differentiating the input. The ASCII value of a is 97 and áis 225. The ASCII value of o is 111 and ó is 243.</p><h4>Kana Sensitivity</h4><p>When Japanese kana characters Hiragana and Katakana are treated differently, it is called Kana sensitive.</p><h4>Width sensitivity</h4><p>When a single-byte character (half-width) and the same character when represented as a double-byte character (full-width) are treated differently then it is width sensitive. Database, Tables and columns with different collation SQL Server 2000 allows the users to create databases, tables and columns in different collations.</p><p><a href="http://www.databasejournal.com/features/mssql/article.php/3302341/SQL-Server-and-Collation.htm" target="_blank" rel="external">source</a></p><h4>Removing tags FROM text</h4><p>The following example shows a way you can remove tags FROM text. In this case only the content of a couple of tags needed to be retrieved FROM the text.</p><p>Full example and problem description can be found <a href="http://stackoverflow.com/questions/16734306/SELECTing-multiple-substrings-FROM-a-field/16774904#16774904%E2%80%8B" target="_blank" rel="external">here</a></p><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> @<span class="keyword">var</span> <span class="keyword">nvarchar</span>(<span class="keyword">max</span>)</span><br><span class="line"><span class="keyword">declare</span> @tag <span class="keyword">nvarchar</span>(<span class="keyword">max</span>)</span><br><span class="line"><span class="keyword">declare</span> @label <span class="keyword">nvarchar</span>(<span class="keyword">max</span>)</span><br><span class="line"><span class="keyword">declare</span> @<span class="keyword">start</span> <span class="built_in">int</span></span><br><span class="line"><span class="keyword">declare</span> @<span class="keyword">stop</span> <span class="built_in">int</span></span><br><span class="line"><span class="keyword">declare</span> @<span class="keyword">len</span> <span class="built_in">int</span></span><br><span class="line"><span class="keyword">declare</span> @needed <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">var</span> = <span class="string">'&lt;Name&gt;Example1&lt;/Name&gt;</span><br><span class="line">&lt;Type&gt;String&lt;/Type&gt;</span><br><span class="line">&lt;Nullable&gt;False&lt;/Nullable&gt;</span><br><span class="line">&lt;AllowBlank&gt;False&lt;/AllowBlank&gt;</span><br><span class="line">&lt;Prompt&gt;Start Date (DD-MMM-YYYY)&lt;/Prompt&gt; </span><br><span class="line">&lt;PromptUser&gt;True&lt;/PromptUser&gt;        </span><br><span class="line">&lt;Parameter&gt; &lt;/Parameter&gt;</span><br><span class="line">&lt;Name&gt;Example2&lt;/Name&gt;      </span><br><span class="line">&lt;Type&gt;String&lt;/Type&gt;      </span><br><span class="line">&lt;Nullable&gt;False&lt;/Nullable&gt;      </span><br><span class="line">&lt;AllowBlank&gt;False&lt;/AllowBlank&gt;</span><br><span class="line">&lt;Prompt&gt;Case (Enter Case Number, % for all, OR %AL% for Alberta)&lt;/Prompt&gt;      </span><br><span class="line">&lt;PromptUser&gt;True&lt;/PromptUser&gt;      </span><br><span class="line">&lt;DefaultValues&gt;        </span><br><span class="line">&lt;Value&gt;%al%&lt;/Value&gt;      </span><br><span class="line">&lt;/DefaultValues&gt;      </span><br><span class="line">&lt;Values&gt;        </span><br><span class="line">    &lt;Value&gt;%al%&lt;/Value&gt;      </span><br><span class="line">&lt;/Values&gt;        </span><br><span class="line">&lt;Parameter&gt;&lt;/Parameter&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> @needed = <span class="number">0</span></span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">start</span> = <span class="keyword">charindex</span>(<span class="string">'&lt;'</span>,@<span class="keyword">var</span>)</span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">stop</span> = <span class="keyword">charindex</span>(<span class="string">'&gt;'</span>,@<span class="keyword">var</span>)</span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">len</span> = @<span class="keyword">stop</span> - @<span class="keyword">start</span> +<span class="number">1</span></span><br><span class="line"><span class="keyword">set</span> @tag = <span class="keyword">substring</span>(@<span class="keyword">var</span>,@<span class="keyword">start</span>,@<span class="keyword">len</span>)</span><br><span class="line"><span class="keyword">set</span> @label = <span class="keyword">substring</span>(@<span class="keyword">var</span>,@<span class="keyword">start</span>+<span class="number">1</span>,@<span class="keyword">len</span><span class="number">-2</span>)</span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">var</span> =  <span class="keyword">replace</span>(@<span class="keyword">var</span>,@tag,@label + <span class="string">' : '</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(@<span class="keyword">start</span> &lt;&gt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">set</span> @<span class="keyword">start</span> = <span class="keyword">charindex</span>(<span class="string">'&lt;'</span>,@<span class="keyword">var</span>)</span><br><span class="line">    <span class="keyword">set</span> @<span class="keyword">stop</span> = <span class="keyword">charindex</span>(<span class="string">'&gt;'</span>,@<span class="keyword">var</span>)</span><br><span class="line">    <span class="keyword">set</span> @<span class="keyword">len</span> = @<span class="keyword">stop</span> - @<span class="keyword">start</span> +<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span>(@<span class="keyword">start</span> &lt;&gt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">begin</span>   </span><br><span class="line">        <span class="keyword">set</span> @tag = <span class="keyword">substring</span>(@<span class="keyword">var</span>,@<span class="keyword">start</span>,@<span class="keyword">len</span>)      </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">charindex</span>(<span class="string">'/'</span>,@tag) = <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">set</span> @label = <span class="keyword">substring</span>(@<span class="keyword">var</span>,@<span class="keyword">start</span>+<span class="number">1</span>,@<span class="keyword">len</span><span class="number">-2</span>)+ <span class="string">' : '</span>     </span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">lower</span>(@label) &lt;&gt; <span class="string">'name : '</span> <span class="keyword">and</span> <span class="keyword">lower</span>(@label) &lt;&gt; <span class="string">'value : '</span> <span class="keyword">and</span> <span class="keyword">lower</span>(@label) &lt;&gt; <span class="string">'prompt : '</span>)</span><br><span class="line">                <span class="keyword">begin</span></span><br><span class="line">                    <span class="keyword">set</span> @needed = <span class="number">0</span></span><br><span class="line">                    <span class="keyword">set</span> @<span class="keyword">var</span> = <span class="keyword">replace</span>(@<span class="keyword">var</span>,@tag,<span class="string">''</span>)</span><br><span class="line">                    <span class="keyword">set</span> @<span class="keyword">start</span> = @<span class="keyword">stop</span> - <span class="keyword">len</span>(@tag)              </span><br><span class="line">                    <span class="keyword">set</span> @<span class="keyword">stop</span> = <span class="keyword">charindex</span>(<span class="string">'&lt;'</span>,@<span class="keyword">var</span>)</span><br><span class="line">                    <span class="keyword">set</span> @<span class="keyword">len</span> = @<span class="keyword">stop</span> - @<span class="keyword">start</span></span><br><span class="line">                    <span class="keyword">set</span> @tag = <span class="keyword">substring</span>(@<span class="keyword">var</span>,@<span class="keyword">start</span>,@<span class="keyword">len</span>)                                      </span><br><span class="line">                    <span class="keyword">set</span> @<span class="keyword">var</span> = <span class="keyword">replace</span>(@<span class="keyword">var</span>,@tag,<span class="string">''</span>)</span><br><span class="line">                <span class="keyword">end</span>             </span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">set</span> @label = <span class="string">''</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">set</span> @<span class="keyword">var</span> = <span class="keyword">replace</span>(@<span class="keyword">var</span>,@tag,@label)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">print <span class="keyword">replace</span>(@<span class="keyword">var</span>,<span class="string">'</span><br><span class="line">'</span>,<span class="string">''</span>)</span><br></pre></td></tr></table></figure><p></p></div></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2016-05-18T13:58:46.896Z"><a href="/2016/05/18/javascript-unit-testing/">2016-05-18</a></time><h1 class="title"><a href="/2016/05/18/javascript-unit-testing/">Javascript unit testing with Qunit</a></h1></header><div class="entry"><p>Qunit is a javascript testing framework created by the jquery foundation. You can download Qunit and find some more documentation at <a href="http://qunitjs.com/" target="_blank" rel="external">http://qunitjs.com/</a> . The site has tutorials and general unit testing info, so I won’t go into details but here is a quick recap to get started. Include qunit and your test.js in your header. Throw in the qunit CSS if you like the fancy red/green colors for your test results.</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">"resources/qunit-1.13.0.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src=<span class="string">"resources/tests.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;link rel=<span class="string">"stylesheet"</span> href=<span class="string">"resources/qunit-1.13.0.css"</span>&gt;</span><br></pre></td></tr></table></figure><p></p><p>In your tests.js add the following code and presto! Your have some working tests.</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">test( <span class="string">"hello string test"</span>, function() &#123;</span><br><span class="line">ok( <span class="number">1</span> === <span class="string">"1"</span>, <span class="string">"Failed!"</span> );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">test( <span class="string">"hello integer test"</span>, function() &#123;</span><br><span class="line">ok( <span class="number">1</span> === <span class="number">1</span>, <span class="string">"Passed!"</span> );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><p>Here’s what that looks like in your browser:</p><p><img src="/images/qunit.png" alt="Qunit basic setup"></p><p>Now let’s add some extensions to Qunit. Link jQuery and the QunitExtensions.js in your header and you’ll get the following extra’s. You could get rid of the jquery, but you’ll have to rewrite some of the extension code.</p><ul><li>Next to existing Test and AsyncTest, the extensions adds a SkippedTest.</li><li>A handy checkbox that will sort the test results by result type</li><li>A checkbox similar to the existing ones that lets you hide/show the SkippedTests</li><li>Setup module function which enables you to define setup and teardown functions for your tests.</li></ul><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">function <span class="title">setupModule</span>(<span class="params">name, setupFunction, tearDownFunction</span>)</span>&#123;…&#125;</span><br></pre></td></tr></table></figure><p></p><p>For the statistics guys/gals I threw in the following code. Which outputs a Junit XML report to the console. The thought behind that is to prepare to dump this report in a CI environment. You’ll have to add the qunit-reporter-junit.js in your header as well.</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">QUnit.jUnitReport = function(report) &#123;</span><br><span class="line">console.log(report.xml);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>Here's an example export:</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;testsuites name=<span class="string">"file:///D:/cloudstation/JS%20testing/testsuite.html"</span> </span><br><span class="line">hostname=<span class="string">"localhost"</span> tests=<span class="string">"2"</span> failures=<span class="string">"0"</span> errors=<span class="string">"0"</span> time=<span class="string">"0.053"</span> timestamp=<span class="string">"2014-11-06T10:40:37Z"</span>&gt;</span><br><span class="line">&lt;testsuite id=<span class="string">"0"</span> name=<span class="string">"Hello Qunit module"</span> hostname=<span class="string">"localhost"</span> tests=<span class="string">"2"</span> failures=<span class="string">"0"</span></span><br><span class="line"> errors=<span class="string">"0"</span> time=<span class="string">"0.001"</span> timestamp=<span class="string">"2014-11-06T10:40:37Z"</span>&gt;</span><br><span class="line">&lt;testcase name=<span class="string">"hello string test"</span> tests=<span class="string">"1"</span> failures=<span class="string">"0"</span> errors=<span class="string">"0"</span> time=<span class="string">"0"</span> timestamp=<span class="string">"2014-11-06T10:40:37Z"</span>&gt;</span><br><span class="line">&lt;/testcase&gt;</span><br><span class="line">&lt;testcase name=<span class="string">"hello integer test"</span> tests=<span class="string">"1"</span> failures=<span class="string">"0"</span> errors=<span class="string">"0"</span> time=<span class="string">"0"</span> timestamp=<span class="string">"2014-11-06T10:40:37Z"</span>&gt;</span><br><span class="line">&lt;/testcase&gt;</span><br><span class="line">&lt;/testsuite&gt;</span><br><span class="line">&lt;testsuite id=<span class="string">"1"</span> name=<span class="string">"skipped test module"</span> hostname=<span class="string">"localhost"</span> tests=<span class="string">"0"</span> failures=<span class="string">"0"</span></span><br><span class="line"> errors=<span class="string">"0"</span> time=<span class="string">"0.001"</span> timestamp=<span class="string">"2014-11-06T10:40:37Z"</span>&gt;</span><br><span class="line">&lt;testcase name=<span class="string">"Igore me (SKIPPED)"</span> tests=<span class="string">"0"</span> failures=<span class="string">"0"</span> errors=<span class="string">"0"</span> time=<span class="string">"0.001"</span> timestamp=<span class="string">"2014-11-06T10:40:37Z"</span>&gt;</span><br><span class="line">&lt;/testcase&gt;</span><br><span class="line">&lt;/testsuite&gt;</span><br><span class="line">&lt;/testsuites&gt;</span><br></pre></td></tr></table></figure><p></p><p>Here’s what the skipped test looks like in code and browser:</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SkippedTest(<span class="string">'Igore me'</span>,function()&#123;</span><br><span class="line">equal(<span class="string">'foo'</span>,<span class="string">'bar'</span>, <span class="string">'this never happened'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><p><img src="/images/qunit2.png" alt="Qunit skipped test"></p><p>Now let’s divide these tests into modules without any setup and teardown functions:</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">setupModule(<span class="string">"Hello Qunit module"</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">test( <span class="string">"hello string test"</span>, function() &#123;</span><br><span class="line">ok( <span class="string">"1"</span> === <span class="string">"1"</span>, <span class="string">"Failed!"</span> );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">test( <span class="string">"hello integer test"</span>, function() &#123;</span><br><span class="line">ok( <span class="number">1</span> === <span class="number">1</span>, <span class="string">"Passed!"</span> );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">setupModule(<span class="string">"skipped test module"</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">SkippedTest(<span class="string">'Igore me'</span>,function()&#123;</span><br><span class="line">equal(<span class="string">'foo'</span>,<span class="string">'bar'</span>, <span class="string">'this never happened'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><p>Notice that the results display the name of the module they belong to, but more practical is the dropdown at the top allowing you to select a module. This will execute only the tests in that module. At some point you may want to have some benchmarks on your script (functional script, not the tests themselves). So lets do that now. Don’t forget to add references to lodash-compat.js and benchmark.js . Just so we have something to test, I added the RandomIntFromInterval and GenerateCode functions (guess what they do..). In the tests. js file I added a formatOutput function to display the results of the benchmark.</p><p>And this code snippet which creates the benchmark suite and adds the two functions to it:</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> suite = <span class="keyword">new</span> Benchmark.Suite;</span><br><span class="line"></span><br><span class="line"><span class="comment">// add tests</span></span><br><span class="line">suite.add(<span class="string">'RandomIntFromInterval_benchmark#test'</span>, function() &#123;</span><br><span class="line"><span class="keyword">var</span> Number = RandomIntFromInterval(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">.add(<span class="string">'GenerateCode_benchmark#test'</span>, function() &#123;</span><br><span class="line"><span class="keyword">var</span> ColorsEnum = [<span class="string">"yellow"</span>, <span class="string">"green"</span>, <span class="string">"orange"</span>,<span class="string">"purple"</span>,<span class="string">"gray"</span>,<span class="string">"magenta"</span>,<span class="string">"red"</span>,<span class="string">"white"</span>,<span class="string">"black"</span>];</span><br><span class="line"><span class="keyword">var</span> mastercode = GenerateCode(ColorsEnum);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// add listeners</span></span><br><span class="line">.on(<span class="string">'cycle'</span>, function(<span class="keyword">event</span>) &#123;</span><br><span class="line"><span class="comment">//console.log(String(event.target));</span></span><br><span class="line">$(<span class="string">"&lt;div&gt;"</span>+formatOutput(String(<span class="keyword">event</span>.target))+<span class="string">"&lt;/div&gt;"</span>).appendTo(<span class="string">"#benchmarks"</span>);</span><br><span class="line">&#125;)</span><br><span class="line">.on(<span class="string">'complete'</span>, function() &#123;</span><br><span class="line">console.log(<span class="string">'Fastest is '</span> + <span class="keyword">this</span>.filter(<span class="string">'fastest'</span>).pluck(<span class="string">'name'</span>));</span><br><span class="line">&#125;)</span><br><span class="line">.on(<span class="string">'start'</span>,function()&#123;</span><br><span class="line"><span class="comment">// do something when the suite starts</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// run async</span></span><br><span class="line">.run(&#123; <span class="string">'async'</span>: <span class="keyword">true</span> &#125;);</span><br></pre></td></tr></table></figure><p></p><p>This will result in the super helpful results below (notice the pretty layout I added to make it match the Qunit results). I’d advise to wrap the benchmark code in a conditional statement so you can toggle them on or off. You can even go so far as to add another checkbox to control that.</p><p><img src="/images/qunit3.png" alt="Qunit benchmark"></p><p>But what about quality you ask. Well let’s add a quality check with jsHint and Qhint (which is just a layer over jsHint). Link to the correct files in the head of the page. And add the following test to your tests.js file (demo.js contains the functions of previous steps):</p><ul><li>qHint(&quot;QHint code quality: &quot;, &quot;resources/demo.js&quot;); Since we did such a fine job in coding those functions I get an “Okay” from jsHint.</li></ul><p><img src="/images/qunit4.png" alt="JShint"></p><p>Now you might get an error like this:</p><p><img src="/images/qunit5.png" alt="JShint error"></p><p>Which means you aren’t running the testsuite file from a server (IIS, or WAMP or anything like it). If the URL in your address bar starts with “file:///”, you’ll get punished with a broken test. So again I’d advise to put a condition around it, to ignore this test in case want to run the testsuite outside of a server environment.</p><p>Finally if you are really really serious about testing, you can run a code coverage test with JS-Coverage. A project called JSCover is being built on top of this, which checks even more metrics. Running JS-coverage involves executing and exe with some parameters, so I’ll refer to their manual instead of repeating it here: [link](http://siliconforks.com/jscoverage/manual.html](http://siliconforks.com/jscoverage/manual.html) .</p><p>Basically it takes your files and inserts instrumenting javascript in them and drops everything in a new directory. In this directory you’ll find a jscoverage.html. <strong>IMPORTANT</strong> just like jsHint you’ll need to run this file on a server. Once you open that, you’ll see a (very ugly) screen like this:</p><p><img src="/images/qunit6.png" alt="JS coverage" title="JS coverage"></p><p>Here I already entered the url to the testsuite.html file.</p><p>IMPORTANT this should be the file inside the newly generated js-coverage directory as this is the one containing the instrumentation code.</p><p>If you click on the summary tab you’ll see something similar to this:</p><p><img src="/images/qunit7.png" alt="JS coverage summary" title="JS coverage summary"></p><p>If you click on one of the files you’ll open up the source tab with some extra info:</p><p><img src="/images/qunit8.png" alt="JS coverage source" title="JS coverage source"></p><p>That concludes this tutorial. I’ll include a zip-file which contains the code of this tutorial.</p><p>As a bonus I’ll add a second zip file containing a simple mastermind game, made TDD style with all these tool. You can find the tests in /js/testsuite.html I already generated the instrumented code which can be found in mastermind/jscoverage_src .</p><p><img src="/images/qunit9.png" alt="Mastermind screenshot" title="Mastermind screenshot"></p><p>The idea behind making that mastermind game, besides the fact that it is fun, is to make a series of these tutorials. Next step will be some better layout and useabilty (yes, I’m talking about a fancy color picker and all that) and javascript templating with mustache.</p><p>List of links for more information:</p><ul><li>[QHint] (https://github.com/gyoshev/qhint)</li><li>[JSHint] (http://www.jshint.com/)</li><li>[Benchmark] (http://benchmarkjs.com/)</li><li>[QUnit] (http://qunitjs.com/)</li><li>[JS-Coverage] (http://siliconforks.com/jscoverage/)</li></ul><p>Zip files with all code for this tutorial:</p><ul><li><a href="/2016/05/18/javascript-unit-testing/mastermind.zip" title="mastermind zip file">mastermind zip file</a></li><li><a href="/2016/05/18/javascript-unit-testing/testsuite.zip" title="test suite zip file">test suite zip file</a></li></ul></div></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2016-05-18T13:51:24.349Z"><a href="/2016/05/18/custom-mediarequest/">2016-05-18</a></time><h1 class="title"><a href="/2016/05/18/custom-mediarequest/">Custom mediaRequest in Sitecore 8</a></h1></header><div class="entry"><p>For a new project in Sitecore 8, we needed an Image cropper. However, the images needed to be cropped dynamically. We started off by implementing the image cropper made by Anders Laub (found <a href="http://laubplusco.net/make-sitecore-deliver-images-fits-screen-part-2/" target="_blank" rel="external">here</a>). After adding the custom image processor, we could use a few querystring parameters to crop the image. the important ones are:</p><ul><li>cw : crop width</li><li>ch : crop height</li><li>c : indicate that this cropper is to be used</li></ul><p>However, when we got this working we noticed that the image was cached by sitecore, but the new querystring parameters were not. When an image is being processed, a cache is created in the app_data/mediacache folder. In a subfolder the transformed image is stored along with some info in a .ini file. The contents of the file will look something like this:</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[key]</span><br><span class="line">?<span class="keyword">as</span>=False&amp;bc=<span class="number">0</span>&amp;h=<span class="number">0</span>&amp;iar=False&amp;mh=<span class="number">0</span>&amp;mw=<span class="number">0</span>&amp;sc=<span class="number">0</span>&amp;thn=False&amp;w=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">[extension]</span><br><span class="line">png</span><br><span class="line"></span><br><span class="line">[headers]</span><br><span class="line">Content-Type: image/png</span><br><span class="line"></span><br><span class="line">[dataFile]</span><br><span class="line"><span class="number">3</span>f427bbc14fa4e4aa399266c96221b51.png</span><br></pre></td></tr></table></figure><p></p><p>The key obviously contains the querystring parameters used in the url to link the image. Notice how all the default parameters are included, but none of the custom ones for the image cropper. To force sitecore to do that you need to write a custom mediarequest class that inherits from the MediaRequest class, found in the Sitecore.Resources.Media namespace. In your new class, you need to override the GetOptions() and Clone() methods of the MediaRequest class. I came up with a super original name for my new class, the CustomMediaRequest class.</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> MediaRequest <span class="title">Clone</span>(<span class="params"></span>)</span><br><span class="line">      </span>&#123;</span><br><span class="line">          Assert.IsTrue((<span class="keyword">bool</span>)(<span class="keyword">base</span>.GetType() == <span class="keyword">typeof</span>(CustomMediaRequest)), </span><br><span class="line">	<span class="string">"The Clone() method must be overridden to support prototyping."</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> CustomMediaRequest &#123; innerRequest = <span class="keyword">this</span>.innerRequest, mediaUri = <span class="keyword">this</span>.mediaUri,</span><br><span class="line">	options = <span class="keyword">this</span>.options, mediaQueryString = <span class="keyword">this</span>.mediaQueryString &#125;;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p></p><p>Since I didn't need any fancy things done here I basically copied the existing code and changed the MediaRequest to CustomMediaRequest. The GetOptions() method is also mostly a copy of the original, but here I added some code to include the new querystring parameters. The parameters both custom and sitecore ones (KnownOptions) are stored in MediaOptions.</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.ProcessCustomParameters(options);                          </span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (!options.CustomOptions.ContainsKey(<span class="string">"c"</span>))</span><br><span class="line">           &#123;</span><br><span class="line">               options.CustomOptions.Add(<span class="string">"c"</span>, queryString.Get(<span class="string">"c"</span>));</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               options.CustomOptions[<span class="string">"c"</span>] = queryString.Get(<span class="string">"c"</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (!options.CustomOptions.ContainsKey(<span class="string">"cw"</span>))</span><br><span class="line">           &#123;</span><br><span class="line">               options.CustomOptions.Add(<span class="string">"cw"</span>, queryString.Get(<span class="string">"cw"</span>));</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               options.CustomOptions[<span class="string">"cw"</span>] = queryString.Get(<span class="string">"cw"</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (!options.CustomOptions.ContainsKey(<span class="string">"ch"</span>))</span><br><span class="line">           &#123;</span><br><span class="line">               options.CustomOptions.Add(<span class="string">"ch"</span>, queryString.Get(<span class="string">"ch"</span>));</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">else</span></span><br><span class="line">           &#123;</span><br><span class="line">               options.CustomOptions[<span class="string">"ch"</span>] = queryString.Get(<span class="string">"ch"</span>);</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure><p></p><p>Finally, we need to add an extra config file in the app_config/include folder. I named mine Sitecore.Media.RequestParser.config since we are replacing the default requestparser with our own.</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;requestParser type=<span class="string">"PioneerDj.SC.Requests.CustomMediaRequest, PioneerDj.SC"</span> </span><br><span class="line">patch:instead=<span class="string">"processor[@type='Sitecore.Resources.Media.MediaRequest, Sitecore.Kernel']"</span> /&gt;</span><br></pre></td></tr></table></figure><p></p><p>Notice how we added the patch:instead. Patch:After won't work as only one RequestParser is used. you also need to patch the Sitecore.Media.RequestProtection.config file, so that sitecore knows about these parameters.</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;protectedMediaQueryParameters&gt;</span><br><span class="line">  ...</span><br><span class="line">  &lt;parameter description=<span class="string">"crop query key"</span> name=<span class="string">"c"</span>/&gt;</span><br><span class="line">  &lt;parameter description=<span class="string">"crop width query key"</span> name=<span class="string">"cw"</span>/&gt;</span><br><span class="line">  &lt;parameter description=<span class="string">"crop height query key"</span> name=<span class="string">"ch"</span>/&gt;</span><br><span class="line">  &lt;parameter description=<span class="string">"jpeg compression"</span> name=<span class="string">"jq"</span>/&gt;</span><br><span class="line">&lt;/protectedMediaQueryParameters&gt;</span><br><span class="line"></span><br><span class="line">&lt;customMediaQueryParameters&gt;</span><br><span class="line">  &lt;parameter description=<span class="string">"image encoding"</span> name=<span class="string">"enc"</span>/&gt;</span><br><span class="line">&lt;/customMediaQueryParameters&gt;</span><br><span class="line">You need to patch <span class="keyword">this</span> before the renderWebEditing pipeline.</span><br><span class="line"></span><br><span class="line">    &lt;pipelines&gt;</span><br><span class="line">      &lt;renderField&gt;</span><br><span class="line">        &lt;processor patch:before=<span class="string">"processor[@type='Sitecore.Pipelines.RenderField.RenderWebEditing, Sitecore.Kernel']"</span></span><br><span class="line">		type=<span class="string">"Sitecore.Pipelines.RenderField.ProtectedImageLinkRenderer, Sitecore.Kernel"</span> /&gt;</span><br><span class="line">      &lt;/renderField&gt;</span><br><span class="line">    &lt;/pipelines&gt;</span><br></pre></td></tr></table></figure><p></p><p>When this is done, the CustomOptions will be added to the querystring and the image cache key in the ini .file will look like this:</p><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[key]</span><br><span class="line">?as=False&amp;bc=0&amp;h=0&amp;iar=False&amp;mh=0&amp;mw=0&amp;sc=0&amp;thn=False&amp;w=0&amp;c=1&amp;ch=550&amp;cw=180</span><br></pre></td></tr></table></figure><p></p><p>Now, every time you render the image with different cropping (querystring) settings, a new image is stored in the mediacache (sub)folder and a new key is added to the .ini file. I hope this short tutorial can help someone looking to extend the image caching.</p><p>The complete CustomMediaRequest class:</p><p></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">using System.Collections.Specialized;</span><br><span class="line">using System.Web;</span><br><span class="line">using Sitecore.Configuration;</span><br><span class="line">using Sitecore.Diagnostics;</span><br><span class="line">using Sitecore.Resources.Media;</span><br><span class="line"></span><br><span class="line">namespace YourProject.SC.Requests</span><br><span class="line">&#123;</span><br><span class="line">    public class CustomMediaRequest : MediaRequest</span><br><span class="line">    &#123;</span><br><span class="line">        private HttpRequest innerRequest;</span><br><span class="line">        private bool isRawUrlSafe;</span><br><span class="line">        private bool isRawUrlSafeInitialized;</span><br><span class="line">        private MediaUrlOptions mediaQueryString;</span><br><span class="line">        private Sitecore.Resources.Media.MediaUri mediaUri;</span><br><span class="line">        private MediaOptions options;        </span><br><span class="line"></span><br><span class="line">        protected override MediaOptions GetOptions()</span><br><span class="line">        &#123;           </span><br><span class="line">            NameValueCollection queryString = this.InnerRequest.QueryString;</span><br><span class="line">            if ((queryString == null) || queryString.HasKeys() )</span><br><span class="line">            &#123;</span><br><span class="line">                options = new MediaOptions();</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                MediaUrlOptions mediaQueryString = this.GetMediaQueryString();</span><br><span class="line">                options = new MediaOptions</span><br><span class="line">                &#123;</span><br><span class="line">                    AllowStretch = mediaQueryString.AllowStretch,</span><br><span class="line">                    BackgroundColor = mediaQueryString.BackgroundColor,</span><br><span class="line">                    IgnoreAspectRatio = mediaQueryString.IgnoreAspectRatio,</span><br><span class="line">                    Scale = mediaQueryString.Scale,</span><br><span class="line">                    Width = mediaQueryString.Width,</span><br><span class="line">                    Height = mediaQueryString.Height,</span><br><span class="line">                    MaxWidth = mediaQueryString.MaxWidth,</span><br><span class="line">                    MaxHeight = mediaQueryString.MaxHeight,</span><br><span class="line">                    Thumbnail = mediaQueryString.Thumbnail</span><br><span class="line">                &#125;;</span><br><span class="line">                if (mediaQueryString.DisableMediaCache)</span><br><span class="line">                &#123;</span><br><span class="line">                    options.UseMediaCache = false;</span><br><span class="line">                &#125;</span><br><span class="line">                string[] strArray = queryString.AllKeys;</span><br><span class="line">                for (int i = 0; i &lt; strArray.Length; i = (int)(i + 1))</span><br><span class="line">                &#123;</span><br><span class="line">                    string str = strArray[i];</span><br><span class="line">                    if ((str != null) &amp;&amp; (queryString.Get(str) != null))</span><br><span class="line">                    &#123;</span><br><span class="line">                        options.CustomOptions[str] = queryString.Get(str);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (!this.IsRawUrlSafe)</span><br><span class="line">            &#123;</span><br><span class="line">                if (Settings.Media.RequestProtection.LoggingEnabled)</span><br><span class="line">                &#123;</span><br><span class="line">                    string urlReferrer = this.GetUrlReferrer();</span><br><span class="line">                    Log.SingleError(string.Format("MediaRequestProtection: An invalid/missing hash value was encountered.</span><br><span class="line">					The expected hash value: &#123;0&#125;. Media URL: &#123;1&#125;, Referring URL: &#123;2&#125;"</span><br><span class="line">                        , HashingUtils.GetAssetUrlHash(this.InnerRequest.Path), this.InnerRequest.Path, string.IsNullOrEmpty(urlReferrer)</span><br><span class="line">						? ((object)"(empty)") : ((object)urlReferrer)), this);</span><br><span class="line">                &#125;</span><br><span class="line">                options = new MediaOptions();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            this.ProcessCustomParameters(options);                          </span><br><span class="line"></span><br><span class="line">            if (!options.CustomOptions.ContainsKey("c"))</span><br><span class="line">            &#123;</span><br><span class="line">                options.CustomOptions.Add("c", queryString.Get("c"));</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                options.CustomOptions["c"] = queryString.Get("c");</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!options.CustomOptions.ContainsKey("cw"))</span><br><span class="line">            &#123;</span><br><span class="line">                options.CustomOptions.Add("cw", queryString.Get("cw"));</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                options.CustomOptions["cw"] = queryString.Get("cw");</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!options.CustomOptions.ContainsKey("ch"))</span><br><span class="line">            &#123;</span><br><span class="line">                options.CustomOptions.Add("ch", queryString.Get("ch"));</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">                options.CustomOptions["ch"] = queryString.Get("ch");</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return options;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public override MediaRequest Clone()</span><br><span class="line">        &#123;</span><br><span class="line">            Assert.IsTrue((bool)(base.GetType() == typeof(CustomMediaRequest)),</span><br><span class="line">			"The Clone() method must be overridden to support prototyping.");</span><br><span class="line">            return new CustomMediaRequest &#123; innerRequest = this.innerRequest,</span><br><span class="line">			mediaUri = this.mediaUri, options = this.options, mediaQueryString = this.mediaQueryString &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>The complete Sitecore.Media.RequestParser.config file:</p><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span>?&gt;</span><br><span class="line">&lt;configuration xmlns:patch=<span class="string">"http://www.sitecore.net/xmlconfig/"</span>&gt;</span><br><span class="line">&lt;sitecore&gt;</span><br><span class="line">	&lt;mediaLibrary&gt;</span><br><span class="line">	&lt;requestParser type=<span class="string">"PioneerDj.SC.Requests.CustomMediaRequest, PioneerDj.SC"</span>  </span><br><span class="line">	patch:instead=<span class="string">"processor[@type='Sitecore.Resources.Media.MediaRequest, Sitecore.Kernel']"</span> /&gt;</span><br><span class="line">	&lt;/mediaLibrary&gt;</span><br><span class="line">&lt;/sitecore&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure><p></p><p>Finally I'd like to thank <a href="http://laubplusco.net/" target="_blank" rel="external">Anders Laub</a>, for his excellent Sitecore blog and image cropper code.</p></div></div></article></div></div></div><aside id="sidebar" class="alignright"><a href="https://twitter.com/RubenVerschuern" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @RubenVerschuern</a><script>!function(t,e,r){var n,s=t.getElementsByTagName(e)[0],i=/^http:/.test(t.location)?"http":"https";t.getElementById(r)||(n=t.createElement(e),n.id=r,n.src=i+"://platform.twitter.com/widgets.js",s.parentNode.insertBefore(n,s))}(document,"script","twitter-wjs")</script><div class="widget tag"><h3 class="title">Tags</h3><ul class="entry"><li><a href="/tags/adyen-skin/">adyen skin</a><small>1</small></li><li><a href="/tags/autocomplete/">autocomplete</a><small>1</small></li><li><a href="/tags/blog/">blog</a><small>1</small></li><li><a href="/tags/browser-extensions/">browser extensions</a><small>1</small></li><li><a href="/tags/cheat-sheet/">cheat sheet</a><small>1</small></li><li><a href="/tags/extension-methods/">extension methods</a><small>1</small></li><li><a href="/tags/filter/">filter</a><small>1</small></li><li><a href="/tags/google-maps/">google maps</a><small>1</small></li><li><a href="/tags/hpp/">hpp</a><small>1</small></li><li><a href="/tags/itemlink/">itemlink</a><small>1</small></li><li><a href="/tags/javascript/">javascript</a><small>2</small></li><li><a href="/tags/markdown/">markdown</a><small>1</small></li><li><a href="/tags/mediarequest/">mediarequest</a><small>1</small></li><li><a href="/tags/multiple-renderings/">multiple renderings</a><small>1</small></li><li><a href="/tags/mvc/">mvc</a><small>1</small></li><li><a href="/tags/pdf/">pdf</a><small>1</small></li><li><a href="/tags/plugins/">plugins</a><small>1</small></li><li><a href="/tags/resharper/">resharper</a><small>1</small></li><li><a href="/tags/shortcut/">shortcut</a><small>1</small></li><li><a href="/tags/sitecore-8/">sitecore 8</a><small>4</small></li><li><a href="/tags/sql/">sql</a><small>3</small></li><li><a href="/tags/tools/">tools</a><small>1</small></li><li><a href="/tags/ucommerce/">ucommerce</a><small>3</small></li><li><a href="/tags/unit-testing/">unit testing</a><small>1</small></li><li><a href="/tags/visual-studio/">visual studio</a><small>1</small></li></ul></div></aside><div class="clearfix"></div></div><footer id="footer" class="inner"><div class="alignleft">&copy; 2016 Ruben Verschueren</div><div class="clearfix"></div></footer><script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="/js/jquery.imagesloaded.min.js"></script><script src="/js/gallery.js"></script><script type="text/javascript">var disqus_shortname="sitecorn";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/count.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript">!function(n){n(".fancybox").fancybox()}(jQuery)</script></body><!-- rebuild by neat -->