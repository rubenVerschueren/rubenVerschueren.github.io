<!-- build time:Wed Oct 19 2016 11:47:17 GMT+0200 (Romance Daylight Time) --><!DOCTYPE HTML><html><head><meta charset="utf-8"><title>Sitecorn</title><meta name="author" content="Ruben Verschueren"><meta name="description" content="web development tips &amp; tricks"><meta name="og:description" content="web development tips &amp; tricks"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:site_name" content="Sitecorn"><meta property="og:url" content="http://www.sitecorn.be/index.html"><meta property="og:image" content="http://www.sitecorn.be/images/sitecorn_large.png"><meta property="og:image:width" content="100"><meta property="og:image:height" content="121"><link rel="icon" type="image/png" href="http://www.sitecorn.be/images/fav.ico"><link href="http://www.sitecorn.be/images/sitecorn_large.png" rel="icon"><link rel="alternate" href="/atom.xml" title="Sitecorn" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/custom.css" media="screen" type="text/css"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-76954315-1","auto"),ga("send","pageview")</script></head></html><body><header id="header" class="inner"><div class="alignleft"><h1><a href="/">Sitecorn</a></h1><h2><a href="/">offering a few kernels of knowledge</a></h2></div><nav id="main-nav" class="alignright"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archives</a></li><li><a href="/about">About</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div id="content" class="inner"><div id="main-col" class="alignleft"><div id="wrapper"><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2016-10-17T14:14:13.074Z"><a href="/2016/10/17/duplicate-sql-databases-in-bulk/">2016-10-17</a></time><h1 class="title"><a href="/2016/10/17/duplicate-sql-databases-in-bulk/">duplicate sql databases in bulk</a></h1></header><div class="entry"><p>This method can be used to create backups and restore databases (with a new name). This is usefull when you need to quickly setup a test version of multiple databases or in case you want to intigrate it as a build step during development. I'll be using it to setup copies of sitecore databases before upgrading to a new version.</p><p>First make sure the logical file names of your databases are the same as the database name. For instance the <strong>Sitecore_Analytics</strong> database should have logical name <strong>Sitecore_Analytics</strong> for the mdf file and logical name <strong>Sitecore_Analytics_log</strong> for the ldf file. This allows the stored procedure to find the files to copy.</p><p>Check the logical filenames in a backup:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">restore filelistonly <span class="keyword">from</span> disk = <span class="string">'D:/Data/backup/Sitecore_Analytics.bak'</span></span><br></pre></td></tr></table></figure><p></p><h3>Stored procedure</h3><p></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">SET ANSI_NULLS ON</span><br><span class="line">GO</span><br><span class="line">SET QUOTED_IDENTIFIER ON</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE DuplicateDatabase</span><br><span class="line">	@<span class="function">sourceDb <span class="title">nvarchar</span>(<span class="params"><span class="number">50</span></span>),</span><br><span class="line">	@removeChars <span class="title">nvarchar</span>(<span class="params"><span class="number">45</span></span>),</span><br><span class="line">	@postfix <span class="title">nvarchar</span>(<span class="params"><span class="number">5</span></span>),</span><br><span class="line">	@backupPath <span class="title">nvarchar</span>(<span class="params"><span class="number">400</span></span>),</span><br><span class="line">	@sqlServerDbFolder <span class="title">nvarchar</span>(<span class="params"><span class="number">100</span></span>)</span><br><span class="line">AS</span><br><span class="line">BEGIN	</span><br><span class="line">	DECLARE @sourceDb_log <span class="title">nvarchar</span>(<span class="params"><span class="number">50</span></span>)</span>;</span><br><span class="line">	DECLARE @<span class="function">destDb <span class="title">nvarchar</span>(<span class="params"><span class="number">50</span></span>)</span>;</span><br><span class="line">	DECLARE @<span class="function">destMdf <span class="title">nvarchar</span>(<span class="params"><span class="number">100</span></span>)</span>;</span><br><span class="line">	DECLARE @<span class="function">destLdf <span class="title">nvarchar</span>(<span class="params"><span class="number">100</span></span>)</span>;</span><br><span class="line"></span><br><span class="line">SET @sourceDb_log = Replace(@sourceDb, @removeChars,<span class="string">''</span>) + <span class="string">'_log'</span></span><br><span class="line">SET @backupPath = @backupPath + @sourceDb + <span class="string">'.bak'</span> --ATTENTION: file must already exist and SQL Server must have access to it</span><br><span class="line"></span><br><span class="line">SET @destDb = @sourceDb + @postfix</span><br><span class="line">SET @destMdf = @sqlServerDbFolder + @destDb + <span class="string">'.mdf'</span></span><br><span class="line">SET @destLdf = @sqlServerDbFolder + @destDb + <span class="string">'_log'</span> + <span class="string">'.ldf'</span></span><br><span class="line"></span><br><span class="line">	BACKUP DATABASE @sourceDb TO DISK = @backupPath</span><br><span class="line"></span><br><span class="line">	RESTORE DATABASE @destDb FROM DISK = @backupPath</span><br><span class="line">	WITH REPLACE,</span><br><span class="line">	   MOVE @sourceDb     TO @destMdf,</span><br><span class="line">	   MOVE @sourceDb_log TO @destLdf</span><br><span class="line">END</span><br><span class="line">GO</span><br></pre></td></tr></table></figure><p></p><h3>Execute stored procedure for each DB</h3><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">exec DuplicateDatabase </span><br><span class="line">&apos;Sitecore_Analytics&apos; -- db name</span><br><span class="line">,&apos;_V6.5&apos;             -- chars to remove from original db name </span><br><span class="line">,&apos;_V6.6&apos;             -- postfix for new db name</span><br><span class="line">,&apos;D:\data\backup\&apos;   -- backup location</span><br><span class="line">,&apos;D:\data\&apos;          -- new db files location</span><br></pre></td></tr></table></figure><p></p><p>You can use the second parameter to remove characters from the original database name. This allows you to copy a xxx_V6.6 database as a xxx_V6.7 database. To create the next version all you need to to is replace the postfix and the database names. Since this may take a few minutes per DB, I would recommended to execute this one DB at a time to avoid any timeouts and more easily detect errors.</p></div><footer><div class="clearfix"></div></footer></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2016-10-07T15:05:00.546Z"><a href="/2016/10/07/upgrade-sitecore-6-5-to-8-2-part1/">2016-10-07</a></time><h1 class="title"><a href="/2016/10/07/upgrade-sitecore-6-5-to-8-2-part1/">The Sitecore Upgrade 6.5 to 8.2 - part 1</a></h1></header><div class="entry"><blockquote><p>I will take the <del>ring</del> Sitecore to <del>Mordor</del> 8.2 – though I do not know the way.</p></blockquote><p>My newest project consists of taking an outdated Sitecore 6.5 project, dust it off and prepare it for the future as a Sitecore 8.2 project. Since a complete rebuild is out of the question I’m left with two options; migrate or upgrade. In case the analytics data can be dropped, Sitecore recommends migration. This would mean creating a clean 8.2 solution and bringing in the code, items, config and other good stuff.</p><p>The other, longer, way is to upgrade. Since the <a href="https://dev.sitecore.net/Downloads/Express_Migration_Tool.aspx" target="_blank" rel="external">Express Migration Tool</a> only supports projects in version 7.2 and up we’ll have to upgade manually. At least until we reach 7.2 and can use the tool.</p><p>Below you may find my preliminary plan to tackle such an upgrade. The first part consists mainly of mapping out the current situation and determining risks and breaking changes in between versions.</p><p><strong>upgrade preparation plan</strong></p><ul><li>Identify state of all environments (which version/branch of the solution is deployed where</li><li>If possible deploy latest version everywhere (preferably done with original dev)</li><li>Identify custom code and which parts of sitecore it plugs in to (together with original dev)</li><li>Identify configuration coupling: which files need to be changed and which can be used as a whole (together with original dev)</li><li>Set up a (manual) test plan for smoke testing site in each intermediate version</li><li>List deprecated functionalities of each intermediate version to determine code to be modified</li><li>List modules that need to be upgraded/replaced</li><li>List prerequisites for each intermediate version</li><li>Choose appropriate windows and SQL server version</li><li>Run a link checker before any new upgrade to check for any extra problems.</li><li>Decide which errors can be ignored (but should be documented) until reaching the final version</li><li>Discuss upgrade strategy with Sitecore (sharing as much info as possible from previous steps), they might have a few tricks up their sleave for this.</li></ul><p><strong>high level upgrade strategy:</strong></p><ul><li>Stop development</li><li>Clear publishing and event queues. set longer timeouts in web.config</li><li>Shrink and rebuild db indexes</li><li>Update all environments with production content (take care not to loose not deployed development)</li><li>Upgrade to version x</li><li>Backup analysis and upgrade reports and logs</li><li>Test, compare to x-1 and backup version x</li><li>Deploy version x to staging or whatever temporary QA site</li><li>Have key users verify version x on staging or whatever temporary QA site</li><li>Upgrade to version x+1</li><li>… repeat until version 7.2 (or whichever version is supported by then)</li><li>Use Express Migration Tool</li><li>If possible destroy webforms and replace with MVC</li></ul><p>This is only the beginning, a lot of choices have to made and discussed with the client. stay tuned for the next exciting episode of The Sitecore Upgrade</p></div><footer><div class="clearfix"></div></footer></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2016-07-28T12:54:43.298Z"><a href="/2016/07/28/add-a-country-to-existing-ucommerce-catalog/">2016-07-28</a></time><h1 class="title"><a href="/2016/07/28/add-a-country-to-existing-ucommerce-catalog/">adding a country to existing uCommerce catalog</a></h1></header><div class="entry"><p>After creating two different catalogs for two different countries (US and Italy) in our uCommerce solution, I needed to add another country. This time however the Italy store and catalog are changed (manually) into an <a href="https://en.wikipedia.org/wiki/Europe,_the_Middle_East_and_Africa" target="_blank" rel="external">EMEA</a> store. Therefore the new country is added to this EMEA store, in my case, using the same payment method and currency.</p><p>Basically you can use the stored procedure for creating a <a href="http://sitecorn.be/2016/07/08/duplicate-ucommerce-store/" target="_blank" rel="external">new store</a> and remove the things you do not need. You will need to change the parameters somewhat to link the new country to the payment method (and perhaps other relations).</p><p>Here’s the stored procedure that let’s you do that.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> ANSI_NULLS <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">SET</span> QUOTED_IDENTIFIER <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="comment">-- =============================================</span></span><br><span class="line"><span class="comment">-- Author: Ruben Verschueren</span></span><br><span class="line"><span class="comment">-- Create date: 2016/07/28</span></span><br><span class="line"><span class="comment">-- Description:	creates a new uCommerce country store </span></span><br><span class="line"><span class="comment">-- and adds it to an existing store</span></span><br><span class="line"><span class="comment">-- =============================================</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> AddCountryToStore	</span><br><span class="line">@createdBy <span class="keyword">nvarchar</span>(<span class="number">20</span>),</span><br><span class="line">@currencyIsoCode <span class="keyword">nvarchar</span>(<span class="number">4</span>),</span><br><span class="line">@currenctExchangeRate <span class="built_in">int</span>,</span><br><span class="line">@countryName <span class="keyword">nvarchar</span>(<span class="number">25</span>),</span><br><span class="line">@vatRate <span class="built_in">decimal</span>(<span class="number">5</span>,<span class="number">2</span>),</span><br><span class="line">@priceGroupDescription <span class="keyword">nvarchar</span>(<span class="number">250</span>),</span><br><span class="line">@cultureCode <span class="keyword">nvarchar</span>(<span class="number">6</span>),	</span><br><span class="line">@paymentMethodId <span class="built_in">int</span>,</span><br><span class="line">@feePercent  <span class="built_in">decimal</span>(<span class="number">18</span>,<span class="number">4</span>),</span><br><span class="line">@shippingMethodName <span class="keyword">nvarchar</span>(<span class="number">128</span>),</span><br><span class="line">@productCatalogId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DECLARE</span> @currencyId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @pricegroupId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @countryId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @shippingMethodId <span class="built_in">int</span>	</span><br><span class="line"><span class="keyword">DECLARE</span> @definitionTypeId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @emailProfileId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @orderNumberId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @productCatalogGroupId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @ProductCatalogPriceGroupRelationId <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> @definitionTypeId = definitionTypeId </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_DefinitionType </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'PaymentMethod'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> @emailProfileId = emailprofileid </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_EmailProfile </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> =<span class="string">'Default'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> @orderNumberId = ordernumberid </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_OrderNumberSerie </span><br><span class="line"><span class="keyword">WHERE</span> OrderNumberName = <span class="string">'Default'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- create currency</span></span><br><span class="line"><span class="keyword">SELECT</span> @currencyId = currencyid </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_Currency </span><br><span class="line"><span class="keyword">WHERE</span> isocode = @currencyIsoCode <span class="keyword">AND</span> deleted = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">IF</span> (@currencyId <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">		PRINT <span class="string">'currency already exists'</span>	</span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_Currency(isocode,exchangerate,deleted,guid) </span><br><span class="line">	<span class="keyword">VALUES</span> (@currencyIsoCode, @currenctExchangeRate, <span class="number">0</span>, NEWID())</span><br><span class="line">	<span class="keyword">SELECT</span> @currencyId =  SCOPE_IDENTITY()</span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- create  pricegroup	</span></span><br><span class="line"><span class="keyword">SELECT</span> @pricegroupId = pricegroupid </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_PriceGroup </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> = @countryName <span class="keyword">AND</span> currencyId = @currencyId</span><br><span class="line"></span><br><span class="line"><span class="keyword">IF</span> (@pricegroupId <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	PRINT <span class="string">'pricegroup already exists'</span>	</span><br><span class="line">	<span class="keyword">UPDATE</span> uCommerce_PriceGroup </span><br><span class="line">	<span class="keyword">SET</span> deleted = <span class="number">0</span> <span class="keyword">WHERE</span> <span class="keyword">name</span> = @countryName <span class="keyword">AND</span> currencyId = @currencyId</span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_PriceGroup(<span class="keyword">name</span>,currencyid,vatrate,description,</span><br><span class="line">		createdon,createdby,modifiedon,modifiedby,deleted,guid)</span><br><span class="line">	<span class="keyword">VALUES</span> (@countryName ,@currencyId,@vatRate, @priceGroupDescription,<span class="keyword">getdate</span>(),</span><br><span class="line">		@createdBy,<span class="keyword">getdate</span>(),@createdBy,<span class="number">0</span>,NEWID())</span><br><span class="line">	<span class="keyword">SELECT</span> @pricegroupId = SCOPE_IDENTITY()</span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- create country</span></span><br><span class="line"><span class="keyword">SELECT</span> @countryId = countryid </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_Country </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> = @countryName <span class="keyword">AND</span> Culture = @cultureCode</span><br><span class="line"><span class="keyword">IF</span> (@countryId <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	PRINT <span class="string">'country already exists'</span></span><br><span class="line">	<span class="keyword">UPDATE</span> uCommerce_Country </span><br><span class="line">	<span class="keyword">SET</span> deleted = <span class="number">0</span></span><br><span class="line">	<span class="keyword">WHERE</span> <span class="keyword">name</span> = @countryName</span><br><span class="line">	<span class="keyword">AND</span> Culture = @cultureCode</span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_Country(<span class="keyword">name</span>,culture,deleted) </span><br><span class="line">	<span class="keyword">VALUES</span> (@countryName, @cultureCode, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">SELECT</span> @countryId =  SCOPE_IDENTITY()</span><br><span class="line">	<span class="keyword">END</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- needed?</span></span><br><span class="line"><span class="keyword">SELECT</span> @shippingMethodId = ShippingMethodId </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_ShippingMethod </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> = @shippingMethodName <span class="keyword">AND</span> paymentmethodId = @paymentMethodId</span><br><span class="line"><span class="keyword">IF</span> (@shippingMethodId <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	PRINT <span class="string">'shipping method already exists'</span></span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_ShippingMethod(<span class="keyword">name</span>,PaymentMethodId,ServiceName,deleted) </span><br><span class="line">	<span class="keyword">VALUES</span> (@shippingMethodName, @paymentMethodId, <span class="string">'SinglePriceService'</span>, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">SELECT</span> @shippingMethodId =  SCOPE_IDENTITY()</span><br><span class="line">	<span class="keyword">END</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">--map shipping method to country</span></span><br><span class="line"><span class="keyword">IF</span>((<span class="keyword">SELECT</span> <span class="keyword">count</span>(*) </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_ShippingMethodCountry </span><br><span class="line"><span class="keyword">WHERE</span> CountryId = @countryId <span class="keyword">and</span> shippingMethodId = @shippingMethodId) = <span class="number">0</span>)</span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="keyword">INSERT</span> uCommerce_ShippingMethodCountry(CountryId,shippingMethodId)</span><br><span class="line"><span class="keyword">VALUES</span>(@CountryId,@shippingMethodId)</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- create ProductCatalog pricegroup relation</span></span><br><span class="line"><span class="keyword">SELECT</span> @ProductCatalogPriceGroupRelationId = ProductCatalogPriceGroupRelationId </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_ProductCatalogPriceGroupRelation</span><br><span class="line"><span class="keyword">WHERE</span> ProductCatalogId = @productCatalogId <span class="keyword">and</span> PriceGroupId = @pricegroupId</span><br><span class="line"><span class="keyword">IF</span> (@ProductCatalogPriceGroupRelationId <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	PRINT <span class="string">'ProductCatalog is already linked to pricegroup'</span></span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_ProductCatalogPriceGroupRelation</span><br><span class="line">	(productcatalogid,PriceGroupId,SortOrder) </span><br><span class="line">	<span class="keyword">VALUES</span> (@productCatalogId,@priceGroupId,<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">SELECT</span> @ProductCatalogPriceGroupRelationId =  SCOPE_IDENTITY()</span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure><p>Now that we created the stored procedure, we can execute it as many times as we want adding more countries to our store. Obviously you need to change the values of the parameters especially the PaymentMethodId and productCatalogId. In the uCommerce backend you will now see the new country, pricegroup etc. If you open up the catalog, you will now see the new country as an option in the allowed priceGroups. Just enable the checkbox and you’re good to go… after you add all the prices on the products that is.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">EXEC AddCountryToStore </span><br><span class="line">'Ruben'	<span class="comment">--createdBy</span></span><br><span class="line">,'EUR'	<span class="comment">--CurrencyIsoCode</span></span><br><span class="line">,100	<span class="comment">--currentExchangeRate</span></span><br><span class="line">,'Netherlands'			<span class="comment">--countryName</span></span><br><span class="line">,0.21				<span class="comment">--vatRate</span></span><br><span class="line">,'Pricing for NL eCommerce'	<span class="comment">--priceGroupDescription</span></span><br><span class="line">,'nl-NL'			<span class="comment">--cultureCode</span></span><br><span class="line">,8				<span class="comment">--PaymentMethodId</span></span><br><span class="line">,0.0000			<span class="comment">--feePerentage</span></span><br><span class="line">,'MyShippingMethod'	<span class="comment">--shippingmethodName</span></span><br><span class="line">,5			<span class="comment">--productCatalogId</span></span><br></pre></td></tr></table></figure></div><footer><div class="clearfix"></div></footer></div></article><nav id="pagination"><a href="/page/2/" class="alignright next">Next</a><div class="clearfix"></div></nav></div></div><aside id="sidebar" class="alignright"><a href="https://twitter.com/RubenVerschuern" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @RubenVerschuern</a><script>!function(t,e,r){var n,s=t.getElementsByTagName(e)[0],i=/^http:/.test(t.location)?"http":"https";t.getElementById(r)||(n=t.createElement(e),n.id=r,n.src=i+"://platform.twitter.com/widgets.js",s.parentNode.insertBefore(n,s))}(document,"script","twitter-wjs")</script><div class="widget tag"><h3 class="title">Tags</h3><ul class="entry"><li><a href="/tags/adyen-skin/">adyen skin</a><small>1</small></li><li><a href="/tags/autocomplete/">autocomplete</a><small>1</small></li><li><a href="/tags/blog/">blog</a><small>1</small></li><li><a href="/tags/browser-extensions/">browser extensions</a><small>1</small></li><li><a href="/tags/cheat-sheet/">cheat sheet</a><small>1</small></li><li><a href="/tags/extension-methods/">extension methods</a><small>1</small></li><li><a href="/tags/filter/">filter</a><small>1</small></li><li><a href="/tags/google-maps/">google maps</a><small>1</small></li><li><a href="/tags/hpp/">hpp</a><small>1</small></li><li><a href="/tags/itemlink/">itemlink</a><small>1</small></li><li><a href="/tags/javascript/">javascript</a><small>2</small></li><li><a href="/tags/maintenance/">maintenance</a><small>1</small></li><li><a href="/tags/markdown/">markdown</a><small>1</small></li><li><a href="/tags/mediarequest/">mediarequest</a><small>1</small></li><li><a href="/tags/migrate/">migrate</a><small>1</small></li><li><a href="/tags/multiple-renderings/">multiple renderings</a><small>1</small></li><li><a href="/tags/mvc/">mvc</a><small>1</small></li><li><a href="/tags/pdf/">pdf</a><small>1</small></li><li><a href="/tags/plugins/">plugins</a><small>1</small></li><li><a href="/tags/resharper/">resharper</a><small>1</small></li><li><a href="/tags/shortcut/">shortcut</a><small>1</small></li><li><a href="/tags/sitecore/">sitecore</a><small>2</small></li><li><a href="/tags/sitecore-8/">sitecore 8</a><small>4</small></li><li><a href="/tags/sql/">sql</a><small>3</small></li><li><a href="/tags/sql-server/">sql server</a><small>1</small></li><li><a href="/tags/t-sql/">t-sql</a><small>1</small></li><li><a href="/tags/tools/">tools</a><small>1</small></li><li><a href="/tags/ucommerce/">ucommerce</a><small>3</small></li><li><a href="/tags/unit-testing/">unit testing</a><small>1</small></li><li><a href="/tags/upgrade/">upgrade</a><small>1</small></li><li><a href="/tags/visual-studio/">visual studio</a><small>1</small></li></ul></div></aside><div class="clearfix"></div></div><footer id="footer" class="inner"><div class="alignleft">&copy; 2016 Ruben Verschueren</div><div class="clearfix"></div></footer><script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="/js/jquery.imagesloaded.min.js"></script><script src="/js/gallery.js"></script><script type="text/javascript">var disqus_shortname="sitecorn";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/count.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript">!function(n){n(".fancybox").fancybox()}(jQuery)</script></body><!-- rebuild by neat -->