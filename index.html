<!-- build time:Fri Mar 24 2017 15:33:31 GMT+0100 (Romance Standard Time) --><!DOCTYPE HTML><html><head><meta charset="utf-8"><title>Sitecorn</title><meta name="author" content="Ruben Verschueren"><meta name="description" content="web development tips &amp; tricks"><meta name="og:description" content="web development tips &amp; tricks"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:site_name" content="Sitecorn"><meta property="og:url" content="http://www.sitecorn.be/index.html"><meta property="og:image" content="http://www.sitecorn.be/images/sitecorn_large.png"><meta property="og:image:width" content="100"><meta property="og:image:height" content="121"><link rel="icon" type="image/png" href="http://www.sitecorn.be/images/fav.ico"><link href="http://www.sitecorn.be/images/sitecorn_large.png" rel="icon"><link rel="alternate" href="/atom.xml" title="Sitecorn" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/custom.css" media="screen" type="text/css"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-76954315-1","auto"),ga("send","pageview")</script></head></html><body><header id="header" class="inner"><div class="alignleft"><h1><a href="/">Sitecorn</a></h1><h2><a href="/">offering a few kernels of knowledge</a></h2></div><nav id="main-nav" class="alignright"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archives</a></li><li><a href="/about">About</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div id="content" class="inner"><div id="main-col" class="alignleft"><div id="wrapper"><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2017-03-17T09:11:50.413Z"><a href="/2017/03/17/upgrade-sitecore-6-5-to-8-2-part-3/">2017-03-17</a></time><h1 class="title"><a href="/2017/03/17/upgrade-sitecore-6-5-to-8-2-part-3/">upgrade-sitecore 6.5 to 8.2 - part 3</a></h1></header><div class="entry"><blockquote><p>Reality check</p></blockquote><p>In <a href="http://www.sitecorn.be/2016/10/19/upgrade-sitecore-6-5-to-8-2-part-2/">part 2</a> I talked about manually upgrading 6.5 to 7.2 and then using the Express Migration Tool, to take it to 8.2. Fortunately, by the time I got started, 6.6 was already supported by EMT.</p><p>Here are the high level steps I took to get to 8.2:</p><ul><li>Made backup of site and databases</li><li>Updated config files to 6.6 in VS solution</li><li>Updated dll references in solution to new sitecore dll versions</li><li>Updated dll references to 3rd party modules</li><li>Referenced new version of HTMLAgilityPack</li></ul><p>The third step was the most annoying here. I had to download the source code of the modules, replace the sitecore references and recompile. Most of them worked with minor tweaking here and there, so I could add them back into my VS solution. The project also heavily relied on 3rd party implementations of the company that originally developed the solution. This included (but was certainly not limited to) a custom buckets setup that didn't really work well on a split CM and CD setup. I removed all of the references to their dll's and started commenting out code until my project would build.</p><p>After this was done I was finally running on Sitecore 6.6 with a semi-disabled custom solution. Time for the EMT to do it's thing.... and it did. after a few hours my site was upgraded to Sitecore 8.2. This meant it was once again time to update my sitecore references, comment out or modify code specific to 6.6 and get my VS solution to build again.</p><p>Once that was done I had a running 8.2 solution and a very ugly website with very few functionality. Time to bucle down and deep dive into the code, fixing commented out code and rewriting parts that were bugging me.</p><p>Deciding what to keep, what to change and what to throw out and rebuild is the biggest challenge in a project like this. Unfortunately I can't give you any clear answers here but I would suggest to change only what's needed.</p><p>I started with adding code generation for templates and a few item locations because I did not want to keep updating the existing POCO classes and &quot;FieldInfo&quot; classes. Hard coded strings give me nightmares, so I'll let TDS worry about that and generate some code for me. After that I changed the way the 3rd party had implemented repositories (aka Search), configuration (which are items with a ton of fields) and dictionary (again custom).</p><p>Since this is now an 8.2 I thought I'd get on board with Helix and made these parts as foundations and/or features. Now if you're reading this, you're in the same boat as me so don't do what I did next. I made a nice foundation for the base functionality of the repositories and started to move the concrete ones into helix features.</p><p>Turns out these existing repositories liked to keep their POCO classes close and the FieldInfo classes and they like their own POCO's and FieldInfo's and ... You can guess the rest. after a few days of messing about, I had around 40 foundations with a lot of references between them. It may not be the best setup, but at least it provides a better view on what is in this project.</p><p><strong>A note on templates</strong></p><p>A problem that seems to occur with sitecore upgrades is the template inheritance tab being broken. There is usually a YSOD pointing to the fieldtype.</p><p><img src="/images/TemplateInheritanceBug.png" alt="" title="Template Inheritance bug"></p><p>The easiest albeit time consuming method of fixing this is opening the template that has the bug (since not all of them may be affected). Switch on Raw Values and copy the contents of the base templates field to your favourite text editor.</p><p><img src="/images/RawValuesSelected.png" alt="" title="View Raw values"></p><p><img src="/images/StandardTemplateBasetemplates.png" alt="" title="standard template base templates"></p><p>I'm sure you can guess where this is going, open the templates belonging to these templates and set field types for those fields that have none selected. When you've gone through all of them the error should be gone. In my case there were some field sections on the standard template that were causing the issue. The following fields had no field type:</p><ul><li>Appearance section : <strong>_Preview</strong> field</li><li>Layout section : <strong>_Controller</strong> field</li><li>Tasks : <strong>_Archive Version date</strong> field</li></ul><p>In case this didn't fix your problem there was an old bug in the sitecore 6-ish versions. In that case it was the _Owner field. Switch to the <strong>core</strong> database. open your content editor and select /sitecore/templates/System/Templates/Sections/Security Finally assign a &quot;Single-Line Text&quot; field type to the __Owner field. And that's the end of that YSOD.</p></div><footer><div class="clearfix"></div></footer></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2016-10-19T09:51:20.985Z"><a href="/2016/10/19/upgrade-sitecore-6-5-to-8-2-part-2/">2016-10-19</a></time><h1 class="title"><a href="/2016/10/19/upgrade-sitecore-6-5-to-8-2-part-2/">upgrade sitecore 6.5 to 8.2 - part 2</a></h1></header><div class="entry"><blockquote><p>On second thought…</p></blockquote><p>In <a href="http://www.sitecorn.be/2016/10/07/upgrade-sitecore-6-5-to-8-2-part1/">part 1</a> I described my temporary plan of attack for upgrading a Sitecore 6.5 project to 8.2. After a nice discussion on the Sitecore community slack I revised my initial plan. Basically I’m going to attach the existing databases to a vanilla site setup and upgrade. Separately I’ll upgrade the code and config to work with a 8.2 site. Finally the two will be linked, resulting in a perfect 8.2 project… or at least that’s the idea and it will have an old(er) codebase.</p><p>As for the code part only necessary changes will be made to get everything up and running. meaning changing or upgrading modules and rewriting code if needed. Sadly that means a lot of sheer UI and webforms code will remain for now.</p><p>The preparation plan will be mostly the same so I’ll leave it out in this post. The upgrade strategy has been changed and is now more detailed.</p><p><strong>Sitecore database upgrade</strong></p><ol style="list-style-type:decimal"><li>Stop development</li><li>Clear publishing and event queues. set longer timeouts in web.config</li><li>Shrink and rebuild db indexes</li><li>Update all environments with production content (take care not to loose not deployed development)</li><li>Link to vanilla site installations</li><li>Upgrade to version 7.2 (or whichever version is supported by then)</li><li>Use Express Migration Tool to upgrade to sitecore version 8.2</li><li>Backup analysis and upgrade reports and logs</li></ol><p><strong>Steps for upgrading new site to next version</strong></p><ol style="list-style-type:decimal"><li>Backup master/core/web/analytics databases of previous version</li><li>Restore backups to DB’s with new version number</li><li>Change app_config/connectionstrings.config to point to new databases (which are still in older version)</li><li>Upgrade databases to new version</li></ol><p>Refer to my post on <a href="http://www.sitecorn.be/2016/10/17/duplicate-sql-databases-in-bulk/">bulk duplicating databases</a> to see how I make the backups and restore duplicates.</p><p><strong>Code / file upgrade</strong></p><ol style="list-style-type:decimal"><li>Modify/upgrade config files to Sitecore version 8.2.</li><li>Refactor code for Sitecore 8.2, commenting out all broken (third party or custom) code.</li><li>Build/deploy this minimal version.</li><li>Use the vanilla site versions until 8.2 is reached</li><li>After upgrading databases, start deploying (working parts of) the code</li><li>Gradually fix the code and update/replace the modules as needed</li><li>Start updating the broken code / modules.</li><li>Deploy version 8.2 (without modules) to staging or whatever temporary QA site</li><li>Have key users verify the minimal 8.2 version on staging or whatever temporary QA site</li><li>Build and deploy upgraded code</li><li>Have key users retest entire site.</li></ol><p><strong>Steps for updating code to 8.2 version</strong></p><ol style="list-style-type:decimal"><li>Branch code</li><li>Modify publish settings and other references to site -&gt; vanilla version 8.2</li><li>Change all references for Sitecore version 6.5 to version 8.2</li><li>Build, bugfix and deploy to site version 8.2</li><li>Run (smoke) tests on site 8.2 (still with vanilla db)</li></ol><p><strong>Link upgraded databases to upgraded site files</strong></p><ol style="list-style-type:decimal"><li>Backup Site and upgraded databases</li><li>Change connection strings to upgraded database</li><li>Test, bugfix and retest</li></ol></div><footer><div class="clearfix"></div></footer></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2016-10-17T14:14:13.074Z"><a href="/2016/10/17/duplicate-sql-databases-in-bulk/">2016-10-17</a></time><h1 class="title"><a href="/2016/10/17/duplicate-sql-databases-in-bulk/">duplicate sql databases in bulk</a></h1></header><div class="entry"><p>This method can be used to create backups and restore databases (with a new name). This is usefull when you need to quickly setup a test version of multiple databases or in case you want to intigrate it as a build step during development. I’ll be using it to setup copies of sitecore databases before upgrading to a new version.</p><p>First make sure the logical file names of your databases are the same as the database name. For instance the <strong>Sitecore_Analytics</strong> database should have logical name <strong>Sitecore_Analytics</strong> for the mdf file and logical name <strong>Sitecore_Analytics_log</strong> for the ldf file. This allows the stored procedure to find the files to copy.</p><p>Check the logical filenames in a backup:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">restore filelistonly <span class="keyword">from</span> disk = <span class="string">'D:/Data/backup/Sitecore_Analytics.bak'</span></span><br></pre></td></tr></table></figure><p></p><h3 id="stored-procedure">Stored procedure</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">SET ANSI_NULLS ON</span><br><span class="line">GO</span><br><span class="line">SET QUOTED_IDENTIFIER ON</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE DuplicateDatabase</span><br><span class="line">	@<span class="function">sourceDb <span class="title">nvarchar</span>(<span class="params"><span class="number">50</span></span>),</span><br><span class="line">	@removeChars <span class="title">nvarchar</span>(<span class="params"><span class="number">45</span></span>),</span><br><span class="line">	@postfix <span class="title">nvarchar</span>(<span class="params"><span class="number">5</span></span>),</span><br><span class="line">	@backupPath <span class="title">nvarchar</span>(<span class="params"><span class="number">400</span></span>),</span><br><span class="line">	@sqlServerDbFolder <span class="title">nvarchar</span>(<span class="params"><span class="number">100</span></span>)</span><br><span class="line">AS</span><br><span class="line">BEGIN	</span><br><span class="line">	DECLARE @sourceDb_log <span class="title">nvarchar</span>(<span class="params"><span class="number">50</span></span>)</span>;</span><br><span class="line">	DECLARE @<span class="function">destDb <span class="title">nvarchar</span>(<span class="params"><span class="number">50</span></span>)</span>;</span><br><span class="line">	DECLARE @<span class="function">destMdf <span class="title">nvarchar</span>(<span class="params"><span class="number">100</span></span>)</span>;</span><br><span class="line">	DECLARE @<span class="function">destLdf <span class="title">nvarchar</span>(<span class="params"><span class="number">100</span></span>)</span>;</span><br><span class="line"></span><br><span class="line">SET @sourceDb_log = Replace(@sourceDb, @removeChars,<span class="string">''</span>) + <span class="string">'_log'</span></span><br><span class="line">SET @backupPath = @backupPath + @sourceDb + <span class="string">'.bak'</span> --ATTENTION: file must already exist and SQL Server must have access to it</span><br><span class="line"></span><br><span class="line">SET @destDb = @sourceDb + @postfix</span><br><span class="line">SET @destMdf = @sqlServerDbFolder + @destDb + <span class="string">'.mdf'</span></span><br><span class="line">SET @destLdf = @sqlServerDbFolder + @destDb + <span class="string">'_log'</span> + <span class="string">'.ldf'</span></span><br><span class="line"></span><br><span class="line">	BACKUP DATABASE @sourceDb TO DISK = @backupPath</span><br><span class="line"></span><br><span class="line">	RESTORE DATABASE @destDb FROM DISK = @backupPath</span><br><span class="line">	WITH REPLACE,</span><br><span class="line">	   MOVE @sourceDb     TO @destMdf,</span><br><span class="line">	   MOVE @sourceDb_log TO @destLdf</span><br><span class="line">END</span><br><span class="line">GO</span><br></pre></td></tr></table></figure><h3 id="execute-stored-procedure-for-each-db">Execute stored procedure for each DB</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">exec DuplicateDatabase </span><br><span class="line">&apos;Sitecore_Analytics&apos; -- db name</span><br><span class="line">,&apos;_V6.5&apos;             -- chars to remove from original db name </span><br><span class="line">,&apos;_V6.6&apos;             -- postfix for new db name</span><br><span class="line">,&apos;D:\data\backup\&apos;   -- backup location</span><br><span class="line">,&apos;D:\data\&apos;          -- new db files location</span><br></pre></td></tr></table></figure><p>You can use the second parameter to remove characters from the original database name. This allows you to copy a xxx_V6.6 database as a xxx_V6.7 database. To create the next version all you need to to is replace the postfix and the database names. Since this may take a few minutes per DB, I would recommended to execute this one DB at a time to avoid any timeouts and more easily detect errors.</p></div><footer><div class="clearfix"></div></footer></div></article><nav id="pagination"><a href="/page/2/" class="alignright next">Next</a><div class="clearfix"></div></nav></div></div><aside id="sidebar" class="alignright"><a href="https://twitter.com/RubenVerschuern" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @RubenVerschuern</a><script>!function(t,e,r){var n,s=t.getElementsByTagName(e)[0],i=/^http:/.test(t.location)?"http":"https";t.getElementById(r)||(n=t.createElement(e),n.id=r,n.src=i+"://platform.twitter.com/widgets.js",s.parentNode.insertBefore(n,s))}(document,"script","twitter-wjs")</script><div class="widget tag"><h3 class="title">Tags</h3><ul class="entry"><li><a href="/tags/adyen-skin/">adyen skin</a><small>1</small></li><li><a href="/tags/autocomplete/">autocomplete</a><small>1</small></li><li><a href="/tags/blog/">blog</a><small>1</small></li><li><a href="/tags/browser-extensions/">browser extensions</a><small>1</small></li><li><a href="/tags/cheat-sheet/">cheat sheet</a><small>1</small></li><li><a href="/tags/extension-methods/">extension methods</a><small>1</small></li><li><a href="/tags/fieldtype-error/">fieldtype error</a><small>1</small></li><li><a href="/tags/filter/">filter</a><small>1</small></li><li><a href="/tags/google-maps/">google maps</a><small>1</small></li><li><a href="/tags/hpp/">hpp</a><small>1</small></li><li><a href="/tags/itemlink/">itemlink</a><small>1</small></li><li><a href="/tags/javascript/">javascript</a><small>2</small></li><li><a href="/tags/maintenance/">maintenance</a><small>1</small></li><li><a href="/tags/markdown/">markdown</a><small>1</small></li><li><a href="/tags/mediarequest/">mediarequest</a><small>1</small></li><li><a href="/tags/migrate/">migrate</a><small>3</small></li><li><a href="/tags/multiple-renderings/">multiple renderings</a><small>1</small></li><li><a href="/tags/mvc/">mvc</a><small>1</small></li><li><a href="/tags/pdf/">pdf</a><small>1</small></li><li><a href="/tags/plugins/">plugins</a><small>1</small></li><li><a href="/tags/resharper/">resharper</a><small>1</small></li><li><a href="/tags/shortcut/">shortcut</a><small>1</small></li><li><a href="/tags/sitecore/">sitecore</a><small>4</small></li><li><a href="/tags/sitecore-8/">sitecore 8</a><small>4</small></li><li><a href="/tags/sql/">sql</a><small>3</small></li><li><a href="/tags/sql-server/">sql server</a><small>1</small></li><li><a href="/tags/t-sql/">t-sql</a><small>1</small></li><li><a href="/tags/template-inheritance/">template inheritance</a><small>1</small></li><li><a href="/tags/tools/">tools</a><small>1</small></li><li><a href="/tags/ucommerce/">ucommerce</a><small>3</small></li><li><a href="/tags/unit-testing/">unit testing</a><small>1</small></li><li><a href="/tags/upgrade/">upgrade</a><small>3</small></li><li><a href="/tags/visual-studio/">visual studio</a><small>1</small></li></ul></div></aside><div class="clearfix"></div></div><footer id="footer" class="inner"><div class="alignleft">&copy; 2017 Ruben Verschueren</div><div class="clearfix"></div></footer><script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="/js/jquery.imagesloaded.min.js"></script><script src="/js/gallery.js"></script><script type="text/javascript">var disqus_shortname="sitecorn";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/count.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript">!function(n){n(".fancybox").fancybox()}(jQuery)</script></body><!-- rebuild by neat -->