<!-- build time:Sat Mar 25 2017 11:26:14 GMT+0100 (Romance Standard Time) --><!DOCTYPE HTML><html><head><meta charset="utf-8"><title>t-sql | Sitecorn</title><meta name="author" content="Ruben Verschueren"><meta name="description" content="web development tips &amp; tricks"><meta name="og:description" content="web development tips &amp; tricks"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:site_name" content="Sitecorn"><meta property="og:url" content="http://www.sitecorn.be/tags/t-sql/index.html"><meta property="og:image" content="http://www.sitecorn.be/images/sitecorn_large.png"><meta property="og:image:width" content="100"><meta property="og:image:height" content="121"><link rel="icon" type="image/png" href="http://www.sitecorn.be/images/fav.ico"><link href="http://www.sitecorn.be/images/sitecorn_large.png" rel="icon"><link rel="alternate" href="/atom.xml" title="Sitecorn" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/custom.css" media="screen" type="text/css"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-76954315-1","auto"),ga("send","pageview")</script></head></html><body><header id="header" class="inner"><div class="alignleft"><h1><a href="/">Sitecorn</a></h1><h2><a href="/">offering a few kernels of knowledge</a></h2></div><nav id="main-nav" class="alignright"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archives</a></li><li><a href="/about">About</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div id="content" class="inner"><div id="main-col" class="alignleft"><div id="wrapper"><h2 class="archive-title tag">t-sql</h2><div class="archive"><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2016-10-17T14:14:13.074Z"><a href="/2016/10/17/duplicate-sql-databases-in-bulk/">2016-10-17</a></time><h1 class="title"><a href="/2016/10/17/duplicate-sql-databases-in-bulk/">duplicate sql databases in bulk</a></h1></header><div class="entry"><p>This method can be used to create backups and restore databases (with a new name). This is usefull when you need to quickly setup a test version of multiple databases or in case you want to intigrate it as a build step during development. Iâ€™ll be using it to setup copies of sitecore databases before upgrading to a new version.</p><p>First make sure the logical file names of your databases are the same as the database name. For instance the <strong>Sitecore_Analytics</strong> database should have logical name <strong>Sitecore_Analytics</strong> for the mdf file and logical name <strong>Sitecore_Analytics_log</strong> for the ldf file. This allows the stored procedure to find the files to copy.</p><p>Check the logical filenames in a backup:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">restore filelistonly <span class="keyword">from</span> disk = <span class="string">'D:/Data/backup/Sitecore_Analytics.bak'</span></span><br></pre></td></tr></table></figure><p></p><h3 id="stored-procedure">Stored procedure</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">SET ANSI_NULLS ON</span><br><span class="line">GO</span><br><span class="line">SET QUOTED_IDENTIFIER ON</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE DuplicateDatabase</span><br><span class="line">	@<span class="function">sourceDb <span class="title">nvarchar</span>(<span class="params"><span class="number">50</span></span>),</span><br><span class="line">	@removeChars <span class="title">nvarchar</span>(<span class="params"><span class="number">45</span></span>),</span><br><span class="line">	@postfix <span class="title">nvarchar</span>(<span class="params"><span class="number">5</span></span>),</span><br><span class="line">	@backupPath <span class="title">nvarchar</span>(<span class="params"><span class="number">400</span></span>),</span><br><span class="line">	@sqlServerDbFolder <span class="title">nvarchar</span>(<span class="params"><span class="number">100</span></span>)</span><br><span class="line">AS</span><br><span class="line">BEGIN	</span><br><span class="line">	DECLARE @sourceDb_log <span class="title">nvarchar</span>(<span class="params"><span class="number">50</span></span>)</span>;</span><br><span class="line">	DECLARE @<span class="function">destDb <span class="title">nvarchar</span>(<span class="params"><span class="number">50</span></span>)</span>;</span><br><span class="line">	DECLARE @<span class="function">destMdf <span class="title">nvarchar</span>(<span class="params"><span class="number">100</span></span>)</span>;</span><br><span class="line">	DECLARE @<span class="function">destLdf <span class="title">nvarchar</span>(<span class="params"><span class="number">100</span></span>)</span>;</span><br><span class="line"></span><br><span class="line">SET @sourceDb_log = Replace(@sourceDb, @removeChars,<span class="string">''</span>) + <span class="string">'_log'</span></span><br><span class="line">SET @backupPath = @backupPath + @sourceDb + <span class="string">'.bak'</span> --ATTENTION: file must already exist and SQL Server must have access to it</span><br><span class="line"></span><br><span class="line">SET @destDb = @sourceDb + @postfix</span><br><span class="line">SET @destMdf = @sqlServerDbFolder + @destDb + <span class="string">'.mdf'</span></span><br><span class="line">SET @destLdf = @sqlServerDbFolder + @destDb + <span class="string">'_log'</span> + <span class="string">'.ldf'</span></span><br><span class="line"></span><br><span class="line">	BACKUP DATABASE @sourceDb TO DISK = @backupPath</span><br><span class="line"></span><br><span class="line">	RESTORE DATABASE @destDb FROM DISK = @backupPath</span><br><span class="line">	WITH REPLACE,</span><br><span class="line">	   MOVE @sourceDb     TO @destMdf,</span><br><span class="line">	   MOVE @sourceDb_log TO @destLdf</span><br><span class="line">END</span><br><span class="line">GO</span><br></pre></td></tr></table></figure><h3 id="execute-stored-procedure-for-each-db">Execute stored procedure for each DB</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">exec DuplicateDatabase </span><br><span class="line">&apos;Sitecore_Analytics&apos; -- db name</span><br><span class="line">,&apos;_V6.5&apos;             -- chars to remove from original db name </span><br><span class="line">,&apos;_V6.6&apos;             -- postfix for new db name</span><br><span class="line">,&apos;D:\data\backup\&apos;   -- backup location</span><br><span class="line">,&apos;D:\data\&apos;          -- new db files location</span><br></pre></td></tr></table></figure><p>You can use the second parameter to remove characters from the original database name. This allows you to copy a xxx_V6.6 database as a xxx_V6.7 database. To create the next version all you need to to is replace the postfix and the database names. Since this may take a few minutes per DB, I would recommended to execute this one DB at a time to avoid any timeouts and more easily detect errors.</p></div></div></article></div></div></div><aside id="sidebar" class="alignright"><a href="https://twitter.com/RubenVerschuern" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @RubenVerschuern</a><script>!function(t,e,r){var n,s=t.getElementsByTagName(e)[0],i=/^http:/.test(t.location)?"http":"https";t.getElementById(r)||(n=t.createElement(e),n.id=r,n.src=i+"://platform.twitter.com/widgets.js",s.parentNode.insertBefore(n,s))}(document,"script","twitter-wjs")</script><div class="widget tag"><h3 class="title">Tags</h3><ul class="entry"><li><a href="/tags/wffm-8-2/">WFFM 8.2</a><small>1</small></li><li><a href="/tags/adyen-skin/">adyen skin</a><small>1</small></li><li><a href="/tags/autocomplete/">autocomplete</a><small>1</small></li><li><a href="/tags/blog/">blog</a><small>1</small></li><li><a href="/tags/browser-extensions/">browser extensions</a><small>1</small></li><li><a href="/tags/bug/">bug</a><small>1</small></li><li><a href="/tags/cheat-sheet/">cheat sheet</a><small>1</small></li><li><a href="/tags/extension-methods/">extension methods</a><small>1</small></li><li><a href="/tags/fieldtype-error/">fieldtype error</a><small>1</small></li><li><a href="/tags/filter/">filter</a><small>1</small></li><li><a href="/tags/google-maps/">google maps</a><small>1</small></li><li><a href="/tags/hpp/">hpp</a><small>1</small></li><li><a href="/tags/itemlink/">itemlink</a><small>1</small></li><li><a href="/tags/javascript/">javascript</a><small>2</small></li><li><a href="/tags/maintenance/">maintenance</a><small>1</small></li><li><a href="/tags/markdown/">markdown</a><small>1</small></li><li><a href="/tags/mediarequest/">mediarequest</a><small>1</small></li><li><a href="/tags/migrate/">migrate</a><small>4</small></li><li><a href="/tags/multiple-renderings/">multiple renderings</a><small>1</small></li><li><a href="/tags/mvc/">mvc</a><small>1</small></li><li><a href="/tags/pdf/">pdf</a><small>1</small></li><li><a href="/tags/plugins/">plugins</a><small>1</small></li><li><a href="/tags/resharper/">resharper</a><small>1</small></li><li><a href="/tags/shortcut/">shortcut</a><small>1</small></li><li><a href="/tags/sitecore/">sitecore</a><small>5</small></li><li><a href="/tags/sitecore-8/">sitecore 8</a><small>4</small></li><li><a href="/tags/sql/">sql</a><small>3</small></li><li><a href="/tags/sql-server/">sql server</a><small>1</small></li><li><a href="/tags/t-sql/">t-sql</a><small>1</small></li><li><a href="/tags/template-inheritance/">template inheritance</a><small>1</small></li><li><a href="/tags/tools/">tools</a><small>1</small></li><li><a href="/tags/ucommerce/">ucommerce</a><small>3</small></li><li><a href="/tags/unit-testing/">unit testing</a><small>1</small></li><li><a href="/tags/upgrade/">upgrade</a><small>4</small></li><li><a href="/tags/visual-studio/">visual studio</a><small>1</small></li></ul></div></aside><div class="clearfix"></div></div><footer id="footer" class="inner"><div class="alignleft">&copy; 2017 Ruben Verschueren</div><div class="clearfix"></div></footer><script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="/js/jquery.imagesloaded.min.js"></script><script src="/js/gallery.js"></script><script type="text/javascript">var disqus_shortname="sitecorn";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/count.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript">!function(n){n(".fancybox").fancybox()}(jQuery)</script></body><!-- rebuild by neat -->