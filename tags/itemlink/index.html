<!-- build time:Thu Sep 08 2016 15:25:34 GMT+0200 (Romance Daylight Time) --><!DOCTYPE HTML><html><head><meta charset="utf-8"><title>itemlink | Sitecorn</title><meta name="author" content="Ruben Verschueren"><meta name="description" content="web development tips &amp; tricks"><meta name="og:description" content="web development tips &amp; tricks"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:site_name" content="Sitecorn"><meta property="og:url" content="http://www.sitecorn.be/tags/itemlink/index.html"><meta property="og:image" content="http://www.sitecorn.be/images/sitecorn_large.png"><meta property="og:image:width" content="100"><meta property="og:image:height" content="121"><link rel="icon" type="image/png" href="http://www.sitecorn.be/images/fav.ico"><link href="http://www.sitecorn.be/images/sitecorn_large.png" rel="icon"><link rel="alternate" href="/atom.xml" title="Sitecorn" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/custom.css" media="screen" type="text/css"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-76954315-1","auto"),ga("send","pageview")</script></head></html><body><header id="header" class="inner"><div class="alignleft"><h1><a href="/">Sitecorn</a></h1><h2><a href="/">offering a few kernels of knowledge</a></h2></div><nav id="main-nav" class="alignright"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archives</a></li><li><a href="/about">About</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div id="content" class="inner"><div id="main-col" class="alignleft"><div id="wrapper"><h2 class="archive-title tag">itemlink</h2><div class="archive"><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2016-07-08T14:48:36.254Z"><a href="/2016/07/08/modifying-sitecore-itemlinks/">2016-07-08</a></time><h1 class="title"><a href="/2016/07/08/modifying-sitecore-itemlinks/">modifying sitecore itemlinks</a></h1></header><div class="entry"><p>I recently had to modify an archive functionality in which you could archive an item or one of it’s children. If you archived child A then it’s parent would be cloned or copied (depending on the situation) to the archive and the child would be moved. But we also have other items that were referencing this item and it would also be possible to archive just one language version. I won’t go into the rather complex rules of the archiving command, but basically I needed to duplicate all references to the child item and link them to the archived item.</p><p>I poked around the web a bit and the <a href="http://www.sitecoreexperts.com/2014/09/bi-directional-one-to-many-and-many-to-many-relationships-in-sitecore/" target="_blank" rel="external">sitecore experts</a> blog sent me in the right direction.</p><p>I used their GetReferrers method to retrieve an IEnumerable of ItemLinks to the original item.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> IEnumerable&lt;ItemLink&gt; <span class="title">GetReferrers</span>(<span class="params">Item item, ID sourceFieldId = <span class="keyword">null</span></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    ItemLink[] referrers = sourceFieldId != <span class="keyword">null</span> <span class="keyword">as</span> ID</span><br><span class="line">    ? Globals.LinkDatabase.GetReferrers(item, sourceFieldId)</span><br><span class="line">    : Globals.LinkDatabase.GetReferrers(item);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> referrers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>After that it is just a matter of looping through the item links and adding a new link to the source item. In case of unarchiving I needed the opposite method to delete some item links, so I added that as well.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AddLinks</span>(<span class="params">Item source, Item target</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    IEnumerable&lt;ItemLink&gt; referencingItems = GetReferrers(source, Constants.FieldId1);</span><br><span class="line">    referencingItems.Union(GetReferrers(source, Constants.FieldId2));</span><br><span class="line">    List&lt;ItemLink&gt; links = referencingItems.ToList();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (links == <span class="keyword">null</span> || !links.Any())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (ItemLink itemLink <span class="keyword">in</span> links)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (itemLink.SourceFieldID != Guid.Empty.ToID())</span><br><span class="line">        &#123;</span><br><span class="line">            Item linkSource = itemLink.GetSourceItem();</span><br><span class="line">            linkSource.Editing.BeginEdit();</span><br><span class="line">            <span class="keyword">string</span> fieldName = linkSource.Fields.FirstOrDefault(f =&gt; f.ID == itemLink.SourceFieldID).Name;</span><br><span class="line">            ((MultilistField)linkSource.Fields[fieldName]).Add(target.ID.ToString());</span><br><span class="line">            linkSource.Editing.AcceptChanges();</span><br><span class="line">            linkSource.Editing.EndEdit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DeleteLinks</span>(<span class="params">Item item</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    IEnumerable&lt;ItemLink&gt; referencingItems = GetReferrers(item, Constants.FieldId1);</span><br><span class="line">    referencingItems.Union(GetReferrers(item, Constants.FieldId2));</span><br><span class="line">    List&lt;ItemLink&gt; links = referencingItems.ToList();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (links == <span class="keyword">null</span> || !links.Any())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (ItemLink itemLink <span class="keyword">in</span> links)</span><br><span class="line">    &#123;</span><br><span class="line">        Item source = itemLink.GetSourceItem();</span><br><span class="line">        source.Editing.BeginEdit();</span><br><span class="line">        MultilistField field = source.Fields.FirstOrDefault(f =&gt; f.ID == itemLink.SourceFieldID);</span><br><span class="line">        <span class="keyword">if</span> (field.Contains(item.ID.ToString()))</span><br><span class="line">        &#123;</span><br><span class="line">            field.Remove(item.ID.ToString());</span><br><span class="line">        &#125;</span><br><span class="line">        source.Editing.AcceptChanges();</span><br><span class="line">        source.Editing.EndEdit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Seeing as both these methods are almost identical, some refactoring is required. It turns out this pattern has a name, the “hole in the middle pattern”. I personally would have called it the donut (doughnut) pattern.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ModifyLinks</span>(<span class="params">Action&lt;MultilistField, Item&gt; action, Item sourceItem, Item targetItem = <span class="keyword">null</span></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    IEnumerable&lt;ItemLink&gt; referencingItems = GetReferrers(sourceItem, IDownloadConstants.ProductsFieldId);</span><br><span class="line">    referencingItems.Union(GetReferrers(sourceItem, ISoftware_InformationConstants.ProductsFieldId));</span><br><span class="line">    List&lt;ItemLink&gt; links = referencingItems.ToList();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (links == <span class="keyword">null</span> || !links.Any())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (ItemLink itemLink <span class="keyword">in</span> links)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (itemLink.SourceFieldID != Guid.Empty.ToID())</span><br><span class="line">        &#123;</span><br><span class="line">            Item source = itemLink.GetSourceItem();</span><br><span class="line">            source.Editing.BeginEdit();</span><br><span class="line">            MultilistField field = source.Fields.FirstOrDefault(f =&gt; f.ID == itemLink.SourceFieldID);</span><br><span class="line"></span><br><span class="line">            action(field, targetItem);</span><br><span class="line"></span><br><span class="line">            source.Editing.AcceptChanges();</span><br><span class="line">            source.Editing.EndEdit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Delete links like in the following snippet, where you pass the source item twice.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ModifyLinks((field, target) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (field.Contains(target.ID.ToString()))</span><br><span class="line">    &#123;</span><br><span class="line">        field.Remove(target.ID.ToString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, item, item);</span><br></pre></td></tr></table></figure><p>Add links in a similar fashion by passing in the source item and the target item. The first being the one you want to copy the links from and the latter being the one you want a new link to.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModifyLinks((field, target) =&gt; &#123;field.Add(target.ID.ToString());&#125;, item, addedItem);</span><br></pre></td></tr></table></figure></div></div></article></div></div></div><aside id="sidebar" class="alignright"><a href="https://twitter.com/RubenVerschuern" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @RubenVerschuern</a><script>!function(t,e,r){var n,s=t.getElementsByTagName(e)[0],i=/^http:/.test(t.location)?"http":"https";t.getElementById(r)||(n=t.createElement(e),n.id=r,n.src=i+"://platform.twitter.com/widgets.js",s.parentNode.insertBefore(n,s))}(document,"script","twitter-wjs")</script><div class="widget tag"><h3 class="title">Tags</h3><ul class="entry"><li><a href="/tags/adyen-skin/">adyen skin</a><small>1</small></li><li><a href="/tags/autocomplete/">autocomplete</a><small>1</small></li><li><a href="/tags/blog/">blog</a><small>1</small></li><li><a href="/tags/browser-extensions/">browser extensions</a><small>1</small></li><li><a href="/tags/cheat-sheet/">cheat sheet</a><small>1</small></li><li><a href="/tags/extension-methods/">extension methods</a><small>1</small></li><li><a href="/tags/filter/">filter</a><small>1</small></li><li><a href="/tags/google-maps/">google maps</a><small>1</small></li><li><a href="/tags/hpp/">hpp</a><small>1</small></li><li><a href="/tags/itemlink/">itemlink</a><small>1</small></li><li><a href="/tags/javascript/">javascript</a><small>2</small></li><li><a href="/tags/markdown/">markdown</a><small>1</small></li><li><a href="/tags/mediarequest/">mediarequest</a><small>1</small></li><li><a href="/tags/multiple-renderings/">multiple renderings</a><small>1</small></li><li><a href="/tags/mvc/">mvc</a><small>1</small></li><li><a href="/tags/pdf/">pdf</a><small>1</small></li><li><a href="/tags/plugins/">plugins</a><small>1</small></li><li><a href="/tags/resharper/">resharper</a><small>1</small></li><li><a href="/tags/shortcut/">shortcut</a><small>1</small></li><li><a href="/tags/sitecore-8/">sitecore 8</a><small>4</small></li><li><a href="/tags/sql/">sql</a><small>3</small></li><li><a href="/tags/tools/">tools</a><small>1</small></li><li><a href="/tags/ucommerce/">ucommerce</a><small>3</small></li><li><a href="/tags/unit-testing/">unit testing</a><small>1</small></li><li><a href="/tags/visual-studio/">visual studio</a><small>1</small></li></ul></div></aside><div class="clearfix"></div></div><footer id="footer" class="inner"><div class="alignleft">&copy; 2016 Ruben Verschueren</div><div class="clearfix"></div></footer><script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="/js/jquery.imagesloaded.min.js"></script><script src="/js/gallery.js"></script><script type="text/javascript">var disqus_shortname="sitecorn";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/count.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript">!function(n){n(".fancybox").fancybox()}(jQuery)</script></body><!-- rebuild by neat -->