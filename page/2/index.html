<!-- build time:Fri Oct 07 2016 17:34:30 GMT+0200 (Romance Daylight Time) --><!DOCTYPE HTML><html><head><meta charset="utf-8"><title>Page 2 | Sitecorn</title><meta name="author" content="Ruben Verschueren"><meta name="description" content="web development tips &amp; tricks"><meta name="og:description" content="web development tips &amp; tricks"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:site_name" content="Sitecorn"><meta property="og:url" content="http://www.sitecorn.be/page/2/index.html"><meta property="og:image" content="http://www.sitecorn.be/images/sitecorn_large.png"><meta property="og:image:width" content="100"><meta property="og:image:height" content="121"><link rel="icon" type="image/png" href="http://www.sitecorn.be/images/fav.ico"><link href="http://www.sitecorn.be/images/sitecorn_large.png" rel="icon"><link rel="alternate" href="/atom.xml" title="Sitecorn" type="application/atom+xml"><link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"><link rel="stylesheet" href="/css/custom.css" media="screen" type="text/css"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-76954315-1","auto"),ga("send","pageview")</script></head></html><body><header id="header" class="inner"><div class="alignleft"><h1><a href="/">Sitecorn</a></h1><h2><a href="/">offering a few kernels of knowledge</a></h2></div><nav id="main-nav" class="alignright"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archives</a></li><li><a href="/about">About</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div id="content" class="inner"><div id="main-col" class="alignleft"><div id="wrapper"><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2016-07-08T14:48:36.254Z"><a href="/2016/07/08/modifying-sitecore-itemlinks/">2016-07-08</a></time><h1 class="title"><a href="/2016/07/08/modifying-sitecore-itemlinks/">modifying sitecore itemlinks</a></h1></header><div class="entry"><p>I recently had to modify an archive functionality in which you could archive an item or one of it’s children. If you archived child A then it’s parent would be cloned or copied (depending on the situation) to the archive and the child would be moved. But we also have other items that were referencing this item and it would also be possible to archive just one language version. I won’t go into the rather complex rules of the archiving command, but basically I needed to duplicate all references to the child item and link them to the archived item.</p><p>I poked around the web a bit and the <a href="http://www.sitecoreexperts.com/2014/09/bi-directional-one-to-many-and-many-to-many-relationships-in-sitecore/" target="_blank" rel="external">sitecore experts</a> blog sent me in the right direction.</p><p>I used their GetReferrers method to retrieve an IEnumerable of ItemLinks to the original item.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> IEnumerable&lt;ItemLink&gt; <span class="title">GetReferrers</span>(<span class="params">Item item, ID sourceFieldId = <span class="keyword">null</span></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    ItemLink[] referrers = sourceFieldId != <span class="keyword">null</span> <span class="keyword">as</span> ID</span><br><span class="line">    ? Globals.LinkDatabase.GetReferrers(item, sourceFieldId)</span><br><span class="line">    : Globals.LinkDatabase.GetReferrers(item);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> referrers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>After that it is just a matter of looping through the item links and adding a new link to the source item. In case of unarchiving I needed the opposite method to delete some item links, so I added that as well.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">AddLinks</span>(<span class="params">Item source, Item target</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    IEnumerable&lt;ItemLink&gt; referencingItems = GetReferrers(source, Constants.FieldId1);</span><br><span class="line">    referencingItems.Union(GetReferrers(source, Constants.FieldId2));</span><br><span class="line">    List&lt;ItemLink&gt; links = referencingItems.ToList();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (links == <span class="keyword">null</span> || !links.Any())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (ItemLink itemLink <span class="keyword">in</span> links)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (itemLink.SourceFieldID != Guid.Empty.ToID())</span><br><span class="line">        &#123;</span><br><span class="line">            Item linkSource = itemLink.GetSourceItem();</span><br><span class="line">            linkSource.Editing.BeginEdit();</span><br><span class="line">            <span class="keyword">string</span> fieldName = linkSource.Fields.FirstOrDefault(f =&gt; f.ID == itemLink.SourceFieldID).Name;</span><br><span class="line">            ((MultilistField)linkSource.Fields[fieldName]).Add(target.ID.ToString());</span><br><span class="line">            linkSource.Editing.AcceptChanges();</span><br><span class="line">            linkSource.Editing.EndEdit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DeleteLinks</span>(<span class="params">Item item</span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    IEnumerable&lt;ItemLink&gt; referencingItems = GetReferrers(item, Constants.FieldId1);</span><br><span class="line">    referencingItems.Union(GetReferrers(item, Constants.FieldId2));</span><br><span class="line">    List&lt;ItemLink&gt; links = referencingItems.ToList();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (links == <span class="keyword">null</span> || !links.Any())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (ItemLink itemLink <span class="keyword">in</span> links)</span><br><span class="line">    &#123;</span><br><span class="line">        Item source = itemLink.GetSourceItem();</span><br><span class="line">        source.Editing.BeginEdit();</span><br><span class="line">        MultilistField field = source.Fields.FirstOrDefault(f =&gt; f.ID == itemLink.SourceFieldID);</span><br><span class="line">        <span class="keyword">if</span> (field.Contains(item.ID.ToString()))</span><br><span class="line">        &#123;</span><br><span class="line">            field.Remove(item.ID.ToString());</span><br><span class="line">        &#125;</span><br><span class="line">        source.Editing.AcceptChanges();</span><br><span class="line">        source.Editing.EndEdit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Seeing as both these methods are almost identical, some refactoring is required. It turns out this pattern has a name, the “hole in the middle pattern”. I personally would have called it the donut (doughnut) pattern.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ModifyLinks</span>(<span class="params">Action&lt;MultilistField, Item&gt; action, Item sourceItem, Item targetItem = <span class="keyword">null</span></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">    IEnumerable&lt;ItemLink&gt; referencingItems = GetReferrers(sourceItem, IDownloadConstants.ProductsFieldId);</span><br><span class="line">    referencingItems.Union(GetReferrers(sourceItem, ISoftware_InformationConstants.ProductsFieldId));</span><br><span class="line">    List&lt;ItemLink&gt; links = referencingItems.ToList();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (links == <span class="keyword">null</span> || !links.Any())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (ItemLink itemLink <span class="keyword">in</span> links)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (itemLink.SourceFieldID != Guid.Empty.ToID())</span><br><span class="line">        &#123;</span><br><span class="line">            Item source = itemLink.GetSourceItem();</span><br><span class="line">            source.Editing.BeginEdit();</span><br><span class="line">            MultilistField field = source.Fields.FirstOrDefault(f =&gt; f.ID == itemLink.SourceFieldID);</span><br><span class="line"></span><br><span class="line">            action(field, targetItem);</span><br><span class="line"></span><br><span class="line">            source.Editing.AcceptChanges();</span><br><span class="line">            source.Editing.EndEdit();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Delete links like in the following snippet, where you pass the source item twice.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ModifyLinks((field, target) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (field.Contains(target.ID.ToString()))</span><br><span class="line">    &#123;</span><br><span class="line">        field.Remove(target.ID.ToString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, item, item);</span><br></pre></td></tr></table></figure><p>Add links in a similar fashion by passing in the source item and the target item. The first being the one you want to copy the links from and the latter being the one you want a new link to.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ModifyLinks((field, target) =&gt; &#123;field.Add(target.ID.ToString());&#125;, item, addedItem);</span><br></pre></td></tr></table></figure></div><footer><div class="clearfix"></div></footer></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2016-07-08T14:30:35.974Z"><a href="/2016/07/08/custom-adyen-skin/">2016-07-08</a></time><h1 class="title"><a href="/2016/07/08/custom-adyen-skin/">custom Adyen skin</a></h1></header><div class="entry"><p>When creating my first skin for Adyen I ran into the problem of translations. Adyen has got it’s language files which you can modify and update as much as you want. But here’s the kicker, once uploaded you cannot reach those files from your skin. This means that if you created a nice header with some text that needs translating, you’ll have to do it yourself.</p><p>So that’s what I did. I added some custom JSON files containing the required translations. They are stored as text files with the locale in the file name. I kept the name resources for convenience. example: resources_it_IT.txt Note that the hyphen is replaced with an underscore.</p><h3 id="shortcuts">Shortcuts</h3><p>Because I had trouble uploading these files in separate folders, I keep them in my javascript folder for now. I took another shortcut in the JSON (again as a proof of concept). The JSON structure is super simple and contains key/value pairs. The keys are actually the CSS selectors I will use to find the location of the text that needs to be translated This results in a somewhat dirty file, but keeps everything nice and simple.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="string">".contact"</span>: <span class="string">"Questions? Call us .... "</span>,</span><br><span class="line">   <span class="string">"h2"</span> : <span class="string">"CHECKOUT"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="script-with-jquery">Script with jQuery</h3><p>The javascript itself is also quite simple. I get the shopperLocale from the form that gets rendered inside the skin and default it to en-GB. Next I set the link on the logo on my skin to homepage in the correct language. Before getting the file, you need to construct a url which points to the correct directory. This has the following format: <strong>/sf/[SKINCODE]/js/[RESOURCE_FILE_NAME]</strong></p><p>Finally I get the file with the needed translations via an AJAX call, loop through the data and use the key/value pairs to set my translation on the page. All of which gets executed when the page has finished loading. Since I already had jquery loaded for other parts, I used it for this code as well.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// determine correct locale</span></span><br><span class="line"><span class="keyword">var</span> locale = $(<span class="string">'[name="shopperLocale"]'</span>).val();</span><br><span class="line"><span class="keyword">if</span> (locale == <span class="literal">null</span> || locale === <span class="string">""</span>) &#123;</span><br><span class="line">   locale = <span class="string">"en_GB"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set logo url to correct language, example: http://www.YOURDOMAIN.com/en-gb/</span></span><br><span class="line">$(<span class="string">".logo"</span>).attr(<span class="string">"href"</span>, <span class="string">"http://www.YOURDOMAIN.com/"</span> + locale.replace(<span class="string">"_"</span>, <span class="string">"-"</span>) + <span class="string">"/"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// construct resource url</span></span><br><span class="line"><span class="keyword">var</span> resourceUrl = <span class="string">"/sf/kTcgNKNd/js/resources_"</span> + locale + <span class="string">".txt"</span>;</span><br><span class="line"></span><br><span class="line">$.ajax(&#123;</span><br><span class="line">   url: resourceUrl,</span><br><span class="line">   contentType: <span class="string">"application/json; charset=utf-8"</span>,</span><br><span class="line">   dataType: <span class="string">"json"</span>,</span><br><span class="line">   success: <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">         <span class="comment">// loop through data and set translation text</span></span><br><span class="line">         $.each(data, <span class="function"><span class="keyword">function</span> (<span class="params">key, val</span>) </span>&#123;</span><br><span class="line">           $(key).html(val);</span><br><span class="line">         &#125;);   </span><br><span class="line">   &#125;,</span><br><span class="line">   error: <span class="function"><span class="keyword">function</span>(<span class="params">xhr, ajaxOptions, thrownError</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(xhr.status);</span><br><span class="line">      <span class="built_in">console</span>.log(thrownError);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>As a final note to this, make sure all links to files in your skin have the same structure as the resource url. I haven’t had much luck with relative url’s using ../ in them. For instance here’s what the part of my skin footer that loads jquery and my script.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/sf/kTcgNKNd/js/jquery.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/sf/kTcgNKNd/js/checkout.js&gt;&lt;/script&gt;</span></span></span><br></pre></td></tr></table></figure><h3 id="display-custom-data">Display custom data</h3><p>Besides the need to display a large amount of data on the HPP (Hosted Payment Page), the customer wanted to display an overview of the order. The problem is that all data you submit to the HPP should be a encoded in the Merchant Signature and the more fields you add the more complicated everything gets. The solution is to make a dictionary of strings and serialize the object as json. This way you can pass it all as the orderdata field.</p><p>another way to do it is to build the html using some sort of string builder and pass that, perhaps url encode it before serializing just to be sure.</p><p>To decode it on the Adyen skin I used the following script. Since I used a dictionary of type <strong>dictionary<string ,="" string=""></string></strong>, I get name / value pairs after de-serialization so I added span tags to the skin which used the same names for their ID attribute.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> orderDataString = <span class="built_in">decodeURIComponent</span>($(<span class="string">"[name='orderData']"</span>).val());</span><br><span class="line"><span class="keyword">var</span> orderJson = $.parseJSON(orderDataString);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cost = $(<span class="string">"[name='paymentAmount']"</span>).val();</span><br><span class="line"><span class="keyword">if</span> (cost !== <span class="string">""</span> &amp;amp;&amp;amp; cost !== <span class="number">0</span>) &#123;</span><br><span class="line">	cost = cost / <span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line">$(<span class="string">"#totalCost"</span>).html(cost + <span class="string">" "</span> + $(<span class="string">"[name='currencyCode']"</span>).val());</span><br><span class="line"></span><br><span class="line">$.each(orderJson, <span class="function"><span class="keyword">function</span> (<span class="params">index, obj</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ($(<span class="string">"#"</span> + obj.Name) != <span class="literal">undefined</span> &amp;&amp; obj.Value != <span class="literal">undefined</span> </span><br><span class="line">		&amp;&amp; obj.Value !== <span class="string">""</span>) &#123;</span><br><span class="line">		<span class="keyword">var</span> val = obj.Value.split(<span class="string">"+"</span>).join(<span class="string">" "</span>);</span><br><span class="line">		<span class="keyword">if</span> (obj.Name === <span class="string">"billingPhone"</span>) &#123;</span><br><span class="line">			val = <span class="string">"+"</span> + val.substring(<span class="number">1</span>, val.length - <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (obj.Name === <span class="string">"backLink"</span>) &#123;</span><br><span class="line">			$(<span class="string">"#"</span> + obj.Name).attr(<span class="string">"href"</span>, val);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$(<span class="string">"#"</span> + obj.Name).html(val);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>In our case we were integrating with Sitecore and uCommerce. When submitting our first tests to the HPP’s we quickly realized it was a bust. As it turned out uCommerce was still using the SHA1 hashing to calculate the HMAC for the merchant signature. We requested the code they used and adapted it to use the SHA256 hashing. We gave our code back, so in case you need it before the next release, just ask your uCommerce buddy and he can hook you up.</p><p>In case you have some other .NET implementation, I made a pull request to the Adyen github, which was since added to their examples. Here you can find the new <a href="https://github.com/Adyen/asp.net/tree/master/AdyenExamples/1.HPP" target="_blank" rel="external">HPP example</a>.</p><h3 id="d-security">3D security</h3><p>If you want to add extra security, Adyen can activate the 3D secure option. For the shopper this means another form to fill out after the completion of the HPP. This extra page is provided by the card issues (aka the bank) so you don’t have any control over it. This includes the layout if you were wondering.</p><p>Our customer wanted to be extra safe, so we had Adyen enabe the 3D secure option. And that’s when it all blew up in my face. When you clicked on the pay button on the HPP page it started flashing. I soon realized this was the javascript that tried to add in the translations. It didn’t have the correct data however since it was the HPP and not our generated payment page that was being submitted.</p><p>To make matters worse there wasn’t any obvious indication why this was happening as everything worked fine without the 3D secure. After inspecting the skin closely I noticed a few issues. The first being we had some elements with the ID’s that Adyen’s was using for their elements on the HPP.</p><p>The biggest issue was that we added a form element in our skin which had the “pageform” as ID. So you can probably guess what happened. Adyen inserts a form element of it’s own with the same id. In fact the form they add, was inserted inside our form element. They’re using javascript to submit the form with id “pageform” and so it all came tumbling down.</p><p>In hindsight we didn’t need the form, so we could easily solve the problem by removing the form from our skin and using different id’s.</p><p>Another issue that can occur is that the payment is authorised but the issuer has some sort of issue. this results in a correct payment, without 3D secure. In that case it’s up to your customer to decide what to do. Adyen can set up rules to support two scenario’s.</p><p>Either the payment is accepted and the shopper is redirected to your confirmation/success page or the fraud score can be raised for those cases and the shopper is redirected to your cancel page.</p></div><footer><div class="clearfix"></div></footer></div></article><article class="post"><div class="post-content"><header><div class="icon"></div><time datetime="2016-07-08T14:15:46.185Z"><a href="/2016/07/08/duplicate-ucommerce-store/">2016-07-08</a></time><h1 class="title"><a href="/2016/07/08/duplicate-ucommerce-store/">duplicating a UCommerce Store</a></h1></header><div class="entry"><p>In a recent project we used uCommerce (6.XX) with Sitecore 8.1 to implement an international webshop.</p><p>Each language in sitecore will eventually be linked to it’s own shop,  starting with the italian one (linked to it-IT).  We opted to create a separate store per country/language in uCommerce because each of them would have some unique features. Some would have different prices, SKU’s, tax calculation and so on.</p><p>After we finished the Italian shop, we wanted to duplicate it so that the content editors wouldn’t have to enter all the common data again. As it turns out this isn’t supported (yet) by uCommerce. After confirming with our uCommerce buddy, I wrote an SQL script that would do just that.</p><p>If you are reading this it means you might be thinking of doing the same thing, so I must warn you I took a few shortcuts here and there.  For instance the product definitions are not duplicated and the script has some hard coded things like disabling product reviews. All this can be easily changed in the stored procedure code below. As the goal was only to do the bulk of the work you might want to create/duplicate more data.</p><p>Here’s a list of what the script creates or duplicates:</p><ul><li>Currency</li><li>PriceGroup</li><li>Country (and existing country is activated)</li><li>Definition</li><li>Payment Method</li><li>Shipping Method</li><li>ProductCatalogGroup</li><li>Mapping between Shipping Method and ProductCatalogGroup</li><li>Mapping between Shipping Methood and Payment Method</li><li>Product Catalog</li><li>Mapping between Product Catalog and PriceGroup</li><li>Categories of products</li><li>Products (duplicating existing only)</li><li>Product properties</li><li>Product description</li><li>Product Category relation</li><li>Price</li><li>Variants</li><li>Variant Properties</li><li>Variant Description</li><li>Variant Price</li></ul><p>You can call the stored procedure with the following script. All you have to do is feed in the correct parameters for you situation. The one shortcut I really don’t like is the SKU suffix. product SKU’s have to be unique so I add the suffix to garantee that. Since the content editor has to enter new ones anyway it’s not that big of a deal.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">EXEC CreateStore </span><br><span class="line">'Ruben'					<span class="comment">--createdBy</span></span><br><span class="line">,'USD'					<span class="comment">--CurrencyIsoCode</span></span><br><span class="line">,143					<span class="comment">--currentExchangeRate</span></span><br><span class="line">,'United States'			<span class="comment">--countryName</span></span><br><span class="line">,0.22					<span class="comment">--vatRate</span></span><br><span class="line">,'Pricing for US eCommerce'	        <span class="comment">--priceGroupDescription</span></span><br><span class="line">,'en-US'				<span class="comment">--cultureCode</span></span><br><span class="line">,'Adyen'				<span class="comment">--definitionName</span></span><br><span class="line">,'Configuration for Adyen'	        <span class="comment">--definitionDescription</span></span><br><span class="line">,'Adyen Test'				<span class="comment">--PaymentMethodName</span></span><br><span class="line">,'Adyen'				<span class="comment">--paymentMethodSeviceName</span></span><br><span class="line">,0.0000					<span class="comment">--feePerentage</span></span><br><span class="line">,'ShipmentName'				<span class="comment">--shippingmethodName</span></span><br><span class="line">,'United States'			<span class="comment">--productCatalogGroupName</span></span><br><span class="line">,'CatalogName'				<span class="comment">--productCatalogName</span></span><br><span class="line">,24					<span class="comment">--parentCatalog</span></span><br><span class="line">,'CategoryName'		                <span class="comment">--productCategoryDefinitionName</span></span><br><span class="line">,'_US'					<span class="comment">--SKU_suffix</span></span><br></pre></td></tr></table></figure><p>And finally the stored procedure script. With the exception of the products (and related data) I always check if the data already exists, so you could execute the stored procedure several times if you wanted to. This was mostly handy during the development and saved me a lot of cleaning up. This way I could add the next bit and just execute the entire thing again without having to restore my database.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> CreateStore	</span><br><span class="line">@createdBy <span class="keyword">nvarchar</span>(<span class="number">20</span>),</span><br><span class="line">@currencyIsoCode <span class="keyword">nvarchar</span>(<span class="number">4</span>),</span><br><span class="line">@currenctExchangeRate <span class="built_in">int</span>,</span><br><span class="line">@countryName <span class="keyword">nvarchar</span>(<span class="number">25</span>),</span><br><span class="line">@vatRate <span class="built_in">decimal</span>(<span class="number">5</span>,<span class="number">2</span>),</span><br><span class="line">@priceGroupDescription <span class="keyword">nvarchar</span>(<span class="number">250</span>),</span><br><span class="line">@cultureCode <span class="keyword">nvarchar</span>(<span class="number">6</span>),</span><br><span class="line">@definitionName <span class="keyword">nvarchar</span>(<span class="number">512</span>),</span><br><span class="line">@definitionDescription <span class="keyword">nvarchar</span>(<span class="keyword">max</span>),</span><br><span class="line">@paymentMethodName <span class="keyword">nvarchar</span>(<span class="number">50</span>),</span><br><span class="line">@paymentMethodServiceName <span class="keyword">nvarchar</span>(<span class="number">50</span>),</span><br><span class="line">@feePercent  <span class="built_in">decimal</span>(<span class="number">18</span>,<span class="number">4</span>),</span><br><span class="line">@shippingMethodName <span class="keyword">nvarchar</span>(<span class="number">128</span>),</span><br><span class="line">@productCatalogGroupName <span class="keyword">nvarchar</span>(<span class="number">128</span>),</span><br><span class="line">@productCatalogName <span class="keyword">nvarchar</span>(<span class="number">128</span>),</span><br><span class="line">@parentCatalog <span class="built_in">int</span>,</span><br><span class="line">@productCategoryDefinitionName <span class="keyword">nvarchar</span>(<span class="number">128</span>),</span><br><span class="line">@skuSuffix <span class="keyword">nvarchar</span>(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">BEGIN</span>	</span><br><span class="line"><span class="keyword">SET</span> NOCOUNT <span class="keyword">ON</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DECLARE</span> @currencyId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @pricegroupId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @countryId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @paymentMethodId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @shippingMethodId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @definitionId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @definitionTypeId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @emailProfileId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @orderNumberId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @productCatalogGroupId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @productCatalogId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @ProductCatalogPriceGroupRelationId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @ProjectCategoryId <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> @definitionTypeId = definitionTypeId </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_DefinitionType </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'PaymentMethod'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> @emailProfileId = emailprofileid </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_EmailProfile </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> =<span class="string">'Default'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> @orderNumberId = ordernumberid </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_OrderNumberSerie </span><br><span class="line"><span class="keyword">WHERE</span> OrderNumberName = <span class="string">'Default'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> @ProjectCategoryId = definitionid </span><br><span class="line"><span class="keyword">FROM</span> ucommerce_Definition </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> = @productCategoryDefinitionName</span><br><span class="line"></span><br><span class="line"><span class="comment">-- create currency</span></span><br><span class="line"><span class="keyword">SELECT</span> @currencyId = currencyid </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_Currency </span><br><span class="line"><span class="keyword">WHERE</span> isocode = @currencyIsoCode <span class="keyword">AND</span> deleted = <span class="number">0</span></span><br><span class="line"><span class="keyword">IF</span> (@currencyId <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	PRINT <span class="string">'currency already exists'</span>	</span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_Currency(isocode,exchangerate,deleted,guid) </span><br><span class="line">	<span class="keyword">VALUES</span> (@currencyIsoCode, @currenctExchangeRate, <span class="number">0</span>, NEWID())</span><br><span class="line">	<span class="keyword">SELECT</span> @currencyId =  SCOPE_IDENTITY()</span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- create  pricegroup	</span></span><br><span class="line"><span class="keyword">SELECT</span> @pricegroupId = pricegroupid </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_PriceGroup </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> = @countryName <span class="keyword">AND</span> currencyId = @currencyId</span><br><span class="line"><span class="keyword">IF</span> (@pricegroupId <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	PRINT <span class="string">'pricegroup already exists'</span>	</span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_PriceGroup(<span class="keyword">name</span>,currencyid,vatrate,description,</span><br><span class="line">	createdon,createdby,modifiedon,modifiedby,deleted,guid)</span><br><span class="line">	<span class="keyword">VALUES</span> (@countryName ,@currencyId,@vatRate, @priceGroupDescription,</span><br><span class="line">	<span class="keyword">getdate</span>(),@createdBy,<span class="keyword">getdate</span>(),@createdBy,<span class="number">0</span>,NEWID())</span><br><span class="line">	<span class="keyword">SELECT</span> @pricegroupId = SCOPE_IDENTITY()</span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- create country</span></span><br><span class="line"><span class="keyword">SELECT</span> @countryId = countryid </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_Country </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> = @countryName <span class="keyword">AND</span> Culture = @cultureCode</span><br><span class="line"><span class="keyword">IF</span> (@countryId <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	PRINT <span class="string">'country already exists, activating it'</span></span><br><span class="line">	<span class="keyword">UPDATE</span> uCommerce_Country </span><br><span class="line">	<span class="keyword">SET</span> deleted = <span class="number">0</span></span><br><span class="line">	<span class="keyword">WHERE</span> <span class="keyword">name</span> = @countryName</span><br><span class="line">	<span class="keyword">AND</span> Culture = @cultureCode</span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_Country(<span class="keyword">name</span>,culture,deleted) </span><br><span class="line">	<span class="keyword">VALUES</span> (@countryName, @cultureCode, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">SELECT</span> @countryId =  SCOPE_IDENTITY()</span><br><span class="line">	<span class="keyword">END</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">-- create definition</span></span><br><span class="line"><span class="keyword">SELECT</span> @definitionId = definitionId </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_Definition </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> = @definitionName <span class="keyword">AND</span> DefinitionTypeId = @definitionTypeId</span><br><span class="line"><span class="keyword">IF</span> (@definitionId <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	PRINT <span class="string">'definition already exists'</span></span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_Definition(<span class="keyword">name</span>,definitiontypeid,description,deleted,sortorder,guid,builtin) </span><br><span class="line">	<span class="keyword">VALUES</span> (@definitionName, @definitionTypeId, @definitionDescription,<span class="number">0</span>,<span class="number">0</span>,NEWID(),<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">SELECT</span> @definitionId =  SCOPE_IDENTITY()</span><br><span class="line">	<span class="keyword">END</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">-- create payment method</span></span><br><span class="line"><span class="keyword">SELECT</span> @paymentMethodId = paymentMethodId </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_PaymentMethod</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> = @paymentMethodName </span><br><span class="line"><span class="keyword">AND</span> paymentMethodServiceName = @paymentMethodServiceName </span><br><span class="line"><span class="keyword">AND</span> definitionId = @definitionId</span><br><span class="line"><span class="keyword">IF</span> (@paymentmethodid <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	PRINT <span class="string">'payment method already exists'</span></span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">INSERT</span> ucommerce_paymentmethod(<span class="keyword">name</span>,feepercent,paymentmethodservicename,enabled,deleted,</span><br><span class="line">	modifiedon,modifiedby,pipeline,definitionid)</span><br><span class="line">	<span class="keyword">VALUES</span> (@paymentmethodname, @feepercent, @paymentmethodservicename,<span class="number">1</span>,<span class="number">0</span>,</span><br><span class="line">	<span class="keyword">getdate</span>(),@createdby,<span class="string">'checkout'</span>,@definitionid)</span><br><span class="line">	<span class="keyword">SELECT</span> @paymentmethodid =  scope_identity()</span><br><span class="line">	<span class="keyword">END</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">-- create shippingMethod</span></span><br><span class="line"><span class="keyword">SELECT</span> @shippingMethodId = ShippingMethodId </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_ShippingMethod </span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> = @shippingMethodName </span><br><span class="line"><span class="keyword">AND</span> paymentmethodId = @paymentMethodId</span><br><span class="line"></span><br><span class="line"><span class="keyword">IF</span> (@shippingMethodId <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	PRINT <span class="string">'shipping method already exists'</span></span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_ShippingMethod(<span class="keyword">name</span>,PaymentMethodId,ServiceName,deleted) </span><br><span class="line">	<span class="keyword">VALUES</span> (@shippingMethodName, @paymentMethodId, <span class="string">'SinglePriceService'</span>, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">SELECT</span> @shippingMethodId =  SCOPE_IDENTITY()</span><br><span class="line">	<span class="keyword">END</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">-- create ProductCatalogGroup</span></span><br><span class="line"><span class="keyword">SELECT</span> @productCatalogGroupId = productCatalogGroupId </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_ProductCatalogGroup</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> = @productCatalogGroupName </span><br><span class="line"><span class="keyword">AND</span> emailprofileId = @emailProfileId </span><br><span class="line"><span class="keyword">AND</span> currencyid= @currencyId <span class="keyword">AND</span> ordernumberId = @orderNumberId</span><br><span class="line"><span class="keyword">IF</span> (@productCatalogGroupId <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	PRINT <span class="string">'ProductCatalogGroup already exists'</span></span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_ProductCatalogGroup(<span class="keyword">name</span>,EmailProfileId,currencyid,domainid,</span><br><span class="line">	OrderNumberId,deleted,CreateCustomersAsMembers,ProductReviewsRequireApproval,guid ) </span><br><span class="line">	<span class="keyword">VALUES</span> (@productCatalogGroupName, @emailProfileId,@currencyid,<span class="string">'website'</span>,</span><br><span class="line">	@orderNumberId,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,NEWID())</span><br><span class="line">	<span class="keyword">SELECT</span> @productCatalogGroupId =  SCOPE_IDENTITY()</span><br><span class="line">	<span class="keyword">END</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">--map shipping method to product catalog group</span></span><br><span class="line"><span class="keyword">IF</span>((<span class="keyword">SELECT</span> <span class="keyword">count</span>(*) <span class="keyword">FROM</span> uCommerce_ProductCatalogGroupShippingMethodMap </span><br><span class="line"><span class="keyword">WHERE</span> productcataloggroupid = @productCatalogGroupId <span class="keyword">AND</span> shippingMethodId = @shippingMethodId) = <span class="number">0</span>)</span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="keyword">INSERT</span> uCommerce_ProductCatalogGroupShippingMethodMap(productcataloggroupid,shippingMethodId)</span><br><span class="line"><span class="keyword">VALUES</span>(@productCatalogGroupId,@shippingMethodId)</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--map shipping method to country</span></span><br><span class="line"><span class="keyword">IF</span>((<span class="keyword">SELECT</span> <span class="keyword">count</span>(*) <span class="keyword">FROM</span> uCommerce_ShippingMethodCountry </span><br><span class="line"><span class="keyword">WHERE</span> CountryId = @countryId <span class="keyword">AND</span> shippingMethodId = @shippingMethodId) = <span class="number">0</span>)</span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="keyword">INSERT</span> uCommerce_ShippingMethodCountry(CountryId,shippingMethodId)</span><br><span class="line"><span class="keyword">VALUES</span>(@CountryId,@shippingMethodId)</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--map shipping method to paymentmethod</span></span><br><span class="line"><span class="keyword">IF</span>((<span class="keyword">SELECT</span> <span class="keyword">count</span>(*) <span class="keyword">FROM</span> uCommerce_ShippingMethodPaymentMethods </span><br><span class="line"><span class="keyword">WHERE</span> PaymentMethodId = @paymentMethodId <span class="keyword">AND</span> shippingMethodId = @shippingMethodId) = <span class="number">0</span>)</span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line"><span class="keyword">INSERT</span> uCommerce_ShippingMethodPaymentMethods(paymentMethodId,shippingMethodId)</span><br><span class="line"><span class="keyword">VALUES</span>(@paymentMethodId,@shippingMethodId)</span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- create ProductCatalog</span></span><br><span class="line"><span class="keyword">SELECT</span> @productCatalogId = productCatalogId </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_ProductCatalog</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">name</span> = @productCatalogName </span><br><span class="line"><span class="keyword">AND</span> ProductCatalogGroupId = @productCatalogGroupId </span><br><span class="line"><span class="keyword">AND</span> PriceGroupId = @pricegroupId</span><br><span class="line"><span class="keyword">IF</span> (@productCatalogId <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	PRINT <span class="string">'ProductCatalog already exists'</span></span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_ProductCatalog(productcataloggroupid,<span class="keyword">name</span>,pricegroupid,ShowPricesIncludingVAT,</span><br><span class="line">	IsVirtual,DisplayOnWebSite,LimitedAccess,Deleted,CreatedBy,CreatedOn,ModifiedBy,ModifiedOn,</span><br><span class="line">	SortOrder,guid) </span><br><span class="line">	<span class="keyword">VALUES</span> (@productCatalogGroupId,@productCatalogName,@pricegroupId,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,@createdBy,<span class="keyword">getdate</span>(),</span><br><span class="line">	@createdBy,<span class="keyword">getdate</span>(),<span class="number">0</span>,NEWID())</span><br><span class="line">	<span class="keyword">SELECT</span> @productCatalogId =  SCOPE_IDENTITY()</span><br><span class="line">	<span class="keyword">END</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">-- create ProductCatalog pricegroup relation</span></span><br><span class="line"><span class="keyword">SELECT</span> @ProductCatalogPriceGroupRelationId = ProductCatalogPriceGroupRelationId </span><br><span class="line"><span class="keyword">FROM</span> uCommerce_ProductCatalogPriceGroupRelation</span><br><span class="line"><span class="keyword">WHERE</span> ProductCatalogId = @productCatalogId <span class="keyword">and</span> PriceGroupId = @pricegroupId</span><br><span class="line"><span class="keyword">IF</span> (@ProductCatalogPriceGroupRelationId <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>)</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	PRINT <span class="string">'ProductCatalog is already linked to pricegroup'</span></span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">ELSE</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_ProductCatalogPriceGroupRelation(productcatalogid,PriceGroupId,SortOrder) </span><br><span class="line">	<span class="keyword">VALUES</span> (@productCatalogId,@priceGroupId,<span class="number">0</span>)</span><br><span class="line">	<span class="keyword">SELECT</span> @ProductCatalogPriceGroupRelationId =  SCOPE_IDENTITY()</span><br><span class="line">	<span class="keyword">END</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">-- create Categories for catalog</span></span><br><span class="line"><span class="keyword">IF</span>((<span class="keyword">SELECT</span> <span class="keyword">count</span>(categoryId) <span class="keyword">FROM</span> uCommerce_Category </span><br><span class="line"><span class="keyword">WHERE</span> productCatalogId = @productCatalogId <span class="keyword">AND</span> definitionId = @ProjectCategoryId) = <span class="number">0</span>)</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> uCommerce_Category(<span class="keyword">name</span>,DisplayOnSite,createdon,ParentCategoryId,</span><br><span class="line">ProductCatalogId,ModifiedOn,ModifiedBy,Deleted,SortOrder,CreatedBy,DefinitionId,guid)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span>,DisplayOnSite,<span class="keyword">getdate</span>(),ParentCategoryId,</span><br><span class="line">@productCatalogId,<span class="keyword">getdate</span>(),@createdBy,<span class="number">0</span>,<span class="number">0</span>,@createdBy,@ProjectCategoryId,NEWID()</span><br><span class="line"><span class="keyword">FROM</span> ucommerce_category</span><br><span class="line"><span class="keyword">WHERE</span> productcatalogid = @parentCatalog</span><br><span class="line"></span><br><span class="line"><span class="comment">-- create products</span></span><br><span class="line"><span class="keyword">IF</span> OBJECT_ID(<span class="string">'tempdb..#Products'</span>) <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DROP</span> <span class="keyword">TABLE</span> #Products</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> productid</span><br><span class="line"><span class="keyword">INTO</span>   #Products</span><br><span class="line"><span class="keyword">FROM</span>   uCommerce_Product</span><br><span class="line"><span class="keyword">WHERE</span> parentproductid <span class="keyword">IS</span> <span class="literal">NULL</span> <span class="keyword">AND</span> variantsku <span class="keyword">IS</span> <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">Id</span> <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @newProductId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @categoryId <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WHILE</span> <span class="keyword">EXISTS</span>(<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> #Products)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">SELECT</span> Top <span class="number">1</span> @<span class="keyword">Id</span> = productid <span class="keyword">FROM</span> #Products</span><br><span class="line">	<span class="comment">/*</span><br><span class="line">	* create product		</span><br><span class="line">	* add product/category relation  =&amp;gt; [uCommerce_CategoryProductRelation]</span><br><span class="line">			=&amp;gt; duplicate FROM existing, change id's to correct product/category id's</span><br><span class="line">	* add price =&amp;gt; [uCommerce_PriceGroupPrice]	</span><br><span class="line">	*/</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">INSERT</span> <span class="keyword">INTO</span> uCommerce_Product(sku,<span class="keyword">name</span>,displayonsite,weight,productDefinitionId,</span><br><span class="line">	AllowOrdering,modifiedBy, ModifiedOn, CreatedBy, CreatedOn, Guid)</span><br><span class="line">	<span class="keyword">SELECT</span> sku + @skuSuffix,<span class="keyword">name</span>,displayonsite,weight,productdefinitionId,</span><br><span class="line">	allowordering,@createdBy, <span class="keyword">getdate</span>(),@createdBy, <span class="keyword">getdate</span>(),NEWID()</span><br><span class="line">	<span class="keyword">FROM</span> uCommerce_Product</span><br><span class="line">	<span class="keyword">WHERE</span> productid = @<span class="keyword">Id</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">SELECT</span> @newProductId =  SCOPE_IDENTITY()		</span><br><span class="line"></span><br><span class="line">	PRINT <span class="string">'creating properties for'</span> + <span class="keyword">cast</span>(@newProductId <span class="keyword">as</span> <span class="built_in">varchar</span>(<span class="number">5</span>))</span><br><span class="line">	<span class="comment">--create product properties</span></span><br><span class="line">	<span class="keyword">INSERT</span> <span class="keyword">INTO</span> uCommerce_ProductProperty(<span class="keyword">value</span>,ProductDefinitionFieldId,ProductId)</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="keyword">value</span>, productdefinitionfieldid, @newProductId</span><br><span class="line">	<span class="keyword">FROM</span> uCommerce_ProductProperty</span><br><span class="line">	<span class="keyword">WHERE</span> productid = @<span class="keyword">Id</span></span><br><span class="line"></span><br><span class="line">	PRINT <span class="string">'creating descriptions for'</span> + <span class="keyword">cast</span>(@newProductId <span class="keyword">as</span> <span class="built_in">varchar</span>(<span class="number">5</span>))</span><br><span class="line">	<span class="comment">--create product descriptions</span></span><br><span class="line">	<span class="keyword">INSERT</span> <span class="keyword">INTO</span> uCommerce_ProductDescription(productid,DisplayName,shortdescription,</span><br><span class="line">	LongDescription,CultureCode)</span><br><span class="line">	<span class="keyword">SELECT</span> @newProductId,displayname,shortdescription,LongDescription,CultureCode</span><br><span class="line">	<span class="keyword">FROM</span> uCommerce_ProductDescription</span><br><span class="line">	<span class="keyword">WHERE</span> productid = @<span class="keyword">id</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">SELECT</span> @categoryId = u2.categoryid </span><br><span class="line">	<span class="keyword">FROM</span> uCommerce_category  u1</span><br><span class="line">	<span class="keyword">INNER</span> <span class="keyword">JOIN</span> uCommerce_category u2 <span class="keyword">on</span> u1.<span class="keyword">name</span> = u2.<span class="keyword">name</span> </span><br><span class="line">	<span class="keyword">INNER</span> <span class="keyword">JOIN</span> uCommerce_CategoryProductRelation cpr</span><br><span class="line">	<span class="keyword">on</span> u1.categoryId = cpr.CategoryId</span><br><span class="line">	<span class="keyword">WHERE</span> cpr.ProductId = @<span class="keyword">Id</span> </span><br><span class="line">	<span class="keyword">AND</span> u2.definitionId = @ProjectCategoryId </span><br><span class="line">	<span class="keyword">AND</span> u2.productcatalogid = @productCatalogId</span><br><span class="line"></span><br><span class="line">	PRINT <span class="string">'creating product/category relations for'</span> + <span class="keyword">cast</span>(@newProductId <span class="keyword">as</span> <span class="built_in">varchar</span>(<span class="number">5</span>))</span><br><span class="line">	<span class="comment">--create category/product relation</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_CategoryProductRelation(ProductId,CategoryId,SortOrder)</span><br><span class="line">	<span class="keyword">VALUES</span> (@newProductId,@categoryId,<span class="number">0</span>)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	PRINT <span class="string">'adding prices for'</span> + <span class="keyword">cast</span>(@newProductId <span class="keyword">as</span> <span class="built_in">varchar</span>(<span class="number">5</span>))</span><br><span class="line">	<span class="comment">--add price</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_PriceGroupPrice(productId,Price,DiscountPrice,PriceGroupId)</span><br><span class="line">	<span class="keyword">SELECT</span> @newProductId, price, discountprice, @pricegroupId</span><br><span class="line">	<span class="keyword">FROM</span> uCommerce_PriceGroupPrice</span><br><span class="line">	<span class="keyword">WHERE</span> ProductId = @<span class="keyword">Id</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">--add product variants and prices</span></span><br><span class="line">	<span class="keyword">IF</span> OBJECT_ID(<span class="string">'tempdb..#Productvariants'</span>) <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DROP</span> <span class="keyword">TABLE</span> #Productvariants</span><br><span class="line">	<span class="keyword">SELECT</span> productid</span><br><span class="line">	<span class="keyword">INTO</span> #Productvariants</span><br><span class="line">	<span class="keyword">FROM</span> uCommerce_Product</span><br><span class="line">	<span class="keyword">WHERE</span> parentproductid = @<span class="keyword">Id</span> </span><br><span class="line">	<span class="keyword">AND</span> variantsku <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">DECLARE</span> @variantId <span class="built_in">int</span></span><br><span class="line">	<span class="keyword">DECLARE</span> @newVariantId <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">WHILE</span> <span class="keyword">EXISTS</span>(<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> #Productvariants)</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">SELECT</span> Top <span class="number">1</span> @variantId = productid </span><br><span class="line">	<span class="keyword">FROM</span> #Productvariants</span><br><span class="line"></span><br><span class="line">	<span class="keyword">INSERT</span> <span class="keyword">INTO</span> uCommerce_Product(sku,variantsku,ParentProductId,<span class="keyword">name</span>,displayonsite,weight,</span><br><span class="line">	productDefinitionId,AllowOrdering,modifiedBy, ModifiedOn, CreatedBy, CreatedOn, Guid)</span><br><span class="line">	<span class="keyword">SELECT</span> sku+ @skuSuffix ,variantsku + @skuSuffix,@newProductId,<span class="keyword">name</span>,displayonsite,weight,</span><br><span class="line">	productdefinitionId,allowordering,@createdBy, <span class="keyword">getdate</span>(),@createdBy, <span class="keyword">getdate</span>(),NEWID()</span><br><span class="line">	<span class="keyword">FROM</span> uCommerce_Product</span><br><span class="line">	<span class="keyword">WHERE</span> productid = @variantId</span><br><span class="line"></span><br><span class="line">	<span class="keyword">SELECT</span> @newVariantId =  SCOPE_IDENTITY()</span><br><span class="line">	</span><br><span class="line">	<span class="comment">--create product variant properties</span></span><br><span class="line">	<span class="keyword">INSERT</span> <span class="keyword">INTO</span> uCommerce_ProductProperty(<span class="keyword">value</span>,ProductDefinitionFieldId,ProductId)</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="keyword">value</span>, productdefinitionfieldid, @newVariantId</span><br><span class="line">	<span class="keyword">FROM</span> uCommerce_ProductProperty</span><br><span class="line">	<span class="keyword">WHERE</span> productid = @variantId</span><br><span class="line"></span><br><span class="line">	<span class="comment">--create product descriptions </span></span><br><span class="line">	<span class="comment">--INSERT INTO uCommerce_ProductDescription(productid,DisplayName,shortdescription,</span></span><br><span class="line">	LongDescription,CultureCode)</span><br><span class="line">	<span class="comment">--SELECT @newProductId,displayname,shortdescription,LongDescription,CultureCode</span></span><br><span class="line">	<span class="comment">--FROM uCommerce_ProductDescription</span></span><br><span class="line">	<span class="comment">--WHERE productid = @variantId</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">--add variant price</span></span><br><span class="line">	<span class="keyword">INSERT</span> uCommerce_PriceGroupPrice(productId,Price,DiscountPrice,PriceGroupId)</span><br><span class="line">	<span class="keyword">SELECT</span> @newVariantId, price, discountprice, @pricegroupId</span><br><span class="line">	<span class="keyword">FROM</span> uCommerce_PriceGroupPrice</span><br><span class="line">	<span class="keyword">WHERE</span> ProductId = @variantId</span><br><span class="line"></span><br><span class="line">	<span class="keyword">Delete</span> #Productvariants <span class="keyword">WHERE</span> productid = @variantId</span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line">	<span class="comment">--end product variants and prices</span></span><br><span class="line">	<span class="keyword">Delete</span> #Products <span class="keyword">WHERE</span> productid = @<span class="keyword">Id</span></span><br><span class="line"><span class="keyword">END</span>	</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure><p>At first it seemed that we didn’t need duplicate product definitions since they would be identical. As it tends to happen in IT… things change. So here’s a script that will do just that. Since the relations between the definitions and the field values will probably change, I did not duplicate them. Here’s a list of what the script duplicates: * ProductDefinition * ProductDefinitionField</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- fields and inheritance should be set manually</span></span><br><span class="line"><span class="comment">-- add ProductDefinitions</span></span><br><span class="line">IF OBJECT_ID('tempdb..#ProductDefinitions') IS NOT NULL <span class="keyword">DROP</span> <span class="keyword">TABLE</span> #ProductDefinitions</span><br><span class="line"><span class="keyword">SELECT</span> productdefinitionid,<span class="keyword">name</span>,deleted</span><br><span class="line"><span class="keyword">INTO</span>   #ProductDefinitions</span><br><span class="line"><span class="keyword">FROM</span>   uCommerce_ProductDefinition</span><br><span class="line"></span><br><span class="line"><span class="keyword">DECLARE</span> @<span class="keyword">name</span> <span class="keyword">nvarchar</span>(<span class="number">512</span>)</span><br><span class="line"><span class="keyword">DECLARE</span> @deleted <span class="built_in">bit</span></span><br><span class="line"><span class="keyword">DECLARE</span> @newDefinitionId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @productdefinitionId <span class="built_in">int</span></span><br><span class="line"><span class="keyword">DECLARE</span> @skuSuffix <span class="keyword">nvarchar</span>(<span class="number">50</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">WHILE</span> <span class="keyword">EXISTS</span>(<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> #ProductDefinitions)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">SELECT</span> Top <span class="number">1</span> @productdefinitionId = productdefinitionId, </span><br><span class="line">	@<span class="keyword">name</span> = <span class="keyword">name</span>, @deleted = deleted </span><br><span class="line">	<span class="keyword">FROM</span> #ProductDefinitions</span><br><span class="line"></span><br><span class="line">	<span class="keyword">INSERT</span> <span class="keyword">INTO</span> uCommerce_ProductDefinition(<span class="keyword">name</span>,deleted,guid)</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="keyword">name</span> + @skuSuffix, @deleted, NEWID()</span><br><span class="line">	<span class="keyword">FROM</span> uCommerce_ProductDefinition</span><br><span class="line">	<span class="keyword">WHERE</span> productdefinitionId = @productdefinitionId</span><br><span class="line"></span><br><span class="line">	<span class="keyword">SELECT</span> @newDefinitionId =  SCOPE_IDENTITY()</span><br><span class="line">	</span><br><span class="line">	<span class="comment">--create product definition fields</span></span><br><span class="line">	<span class="keyword">INSERT</span> <span class="keyword">INTO</span> uCommerce_ProductDefinitionField</span><br><span class="line">	<span class="keyword">SELECT</span> DataTypeId,@newDefinitionId,<span class="keyword">Name</span>,DisplayOnSite,IsVariantProperty,Multilingual</span><br><span class="line">	,RenderInEditor,Searchable,Deleted,SortOrder,Facet,NEWID()</span><br><span class="line">	<span class="keyword">FROM</span> uCommerce_ProductDefinitionField</span><br><span class="line">	<span class="keyword">WHERE</span> productdefinitionid = @productdefinitionId</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">Delete</span> #ProductDefinitions <span class="keyword">WHERE</span> productdefinitionid = @productdefinitionid</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure><p>And that’s the end of this chapter. The presented code here may not be a silver bullet but I hope it’s at least a machete clearing a path for you.</p></div><footer><div class="clearfix"></div></footer></div></article><nav id="pagination"><a href="/" class="alignleft prev">Prev</a> <a href="/page/3/" class="alignright next">Next</a><div class="clearfix"></div></nav></div></div><aside id="sidebar" class="alignright"><a href="https://twitter.com/RubenVerschuern" class="twitter-follow-button" data-show-count="false" data-size="large">Follow @RubenVerschuern</a><script>!function(t,e,r){var n,s=t.getElementsByTagName(e)[0],i=/^http:/.test(t.location)?"http":"https";t.getElementById(r)||(n=t.createElement(e),n.id=r,n.src=i+"://platform.twitter.com/widgets.js",s.parentNode.insertBefore(n,s))}(document,"script","twitter-wjs")</script><div class="widget tag"><h3 class="title">Tags</h3><ul class="entry"><li><a href="/tags/adyen-skin/">adyen skin</a><small>1</small></li><li><a href="/tags/autocomplete/">autocomplete</a><small>1</small></li><li><a href="/tags/blog/">blog</a><small>1</small></li><li><a href="/tags/browser-extensions/">browser extensions</a><small>1</small></li><li><a href="/tags/cheat-sheet/">cheat sheet</a><small>1</small></li><li><a href="/tags/extension-methods/">extension methods</a><small>1</small></li><li><a href="/tags/filter/">filter</a><small>1</small></li><li><a href="/tags/google-maps/">google maps</a><small>1</small></li><li><a href="/tags/hpp/">hpp</a><small>1</small></li><li><a href="/tags/itemlink/">itemlink</a><small>1</small></li><li><a href="/tags/javascript/">javascript</a><small>2</small></li><li><a href="/tags/markdown/">markdown</a><small>1</small></li><li><a href="/tags/mediarequest/">mediarequest</a><small>1</small></li><li><a href="/tags/migrate/">migrate</a><small>1</small></li><li><a href="/tags/multiple-renderings/">multiple renderings</a><small>1</small></li><li><a href="/tags/mvc/">mvc</a><small>1</small></li><li><a href="/tags/pdf/">pdf</a><small>1</small></li><li><a href="/tags/plugins/">plugins</a><small>1</small></li><li><a href="/tags/resharper/">resharper</a><small>1</small></li><li><a href="/tags/shortcut/">shortcut</a><small>1</small></li><li><a href="/tags/sitecore/">sitecore</a><small>1</small></li><li><a href="/tags/sitecore-8/">sitecore 8</a><small>4</small></li><li><a href="/tags/sql/">sql</a><small>3</small></li><li><a href="/tags/tools/">tools</a><small>1</small></li><li><a href="/tags/ucommerce/">ucommerce</a><small>3</small></li><li><a href="/tags/unit-testing/">unit testing</a><small>1</small></li><li><a href="/tags/upgrade/">upgrade</a><small>1</small></li><li><a href="/tags/visual-studio/">visual studio</a><small>1</small></li></ul></div></aside><div class="clearfix"></div></div><footer id="footer" class="inner"><div class="alignleft">&copy; 2016 Ruben Verschueren</div><div class="clearfix"></div></footer><script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script><script src="/js/jquery.imagesloaded.min.js"></script><script src="/js/gallery.js"></script><script type="text/javascript">var disqus_shortname="sitecorn";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/count.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css"><script src="/fancybox/jquery.fancybox.pack.js"></script><script type="text/javascript">!function(n){n(".fancybox").fancybox()}(jQuery)</script></body><!-- rebuild by neat -->